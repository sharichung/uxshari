<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UXShari æœƒå“¡å°ˆå€ | å­¸ç¿’å„€è¡¨æ¿</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="assets/css/general.css">
  <style>
    /* Loading spinner */
    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    /* Credits card animation */
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .credits-updated {
      animation: pulse 0.5s ease-in-out;
    }
    
    /* Status badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      font-size: 0.875rem;
      font-weight: 600;
    }
    
    .status-badge.free {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      color: #6b7280;
    }
    
    .status-badge.paid {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
  </style>
</head>
<body class="min-vh-100 d-flex flex-column bg-light">

  <!-- Loading Spinner -->
  <div id="loading-overlay" class="spinner-overlay">
    <div class="text-center">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
      </div>
      <p class="mt-3 text-muted">è¼‰å…¥æ‚¨çš„è³‡æ–™...</p>
    </div>
  </div>

  <!-- Navbar -->
  <div id="navbar"><nav id="mainNavbar"
    class="fade-in-down navbar-general navbar navbar-expand-lg position-fixed top-0 start-0 end-0 px-3 py-2 bg-white shadow-sm transition"
    style="z-index: 1030;">
    <div class="container">
      <!-- Logo -->
      <a href="dashboard.html" class="enter-fadein logo futuristic-hover navbar-brand d-flex align-items-center">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1017.99 1024" width="24" height="24" class="me-2"
          alt="UXShari UX å­¸ç¿’å¹³å° Logo">
          <path
            d="m662.99 0 24 35.99c-58.06 30.18-115.56 68.24-163.52 112.99-70.02 65.33-116.87 138.09-103.04 238.01 8.19 59.16 31.31 115.54 56.58 169.01l17.19-33.29c49.23-84.32 134.1-142.53 225.8-172.69-17.41 20.48-33.56 42.23-46.8 65.69-32.86 58.28-50.98 125.62-24.69 190.28 60.95 149.87 255.97 98.73 368.99 47.02l.49 1.48C920.22 783.53 765.07 907.6 592 860.5c-72.54-19.74-122.63-68.39-136.68-143.32-1.57-8.36-1.84-16.93-3.81-25.18L24.99 1024h-2L0 989.02C97.58 936.38 191.59 843.53 221.49 734c30.92-113.28-26.26-241.7-88.68-334.31-6.46-9.59-14.29-18.74-19.81-28.67L660.99 0z"
            style="fill:#ff9500" />
        </svg>
        UX Shari
      </a>


      <a class="d-flex align-items-center text-dark text-decoration-none" href="account.html" role="button">
        <i class="fas fa-user-circle text-dark" role="img" aria-label="æœƒå“¡å¸³è™Ÿ"></i>
      </a>
    </div>
  </nav>

  <script>
    window.addEventListener('scroll', function () {
      const navbar = document.getElementById('mainNavbar');
      if (window.scrollY > 10) {
        navbar.classList.add('navbar-scrolled');
      } else {
        navbar.classList.remove('navbar-scrolled');
      }
    });
  </script>
</div>

  <!-- Main Content -->
  <main class="flex-grow-1 d-flex flex-column" style="padding-top:80px;">
    
    <!-- æœƒå“¡ç‹€æ…‹æ©«å¹… -->
    <section class="container py-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h1 class="h4 mb-2">
                <i class="fas fa-user-circle text-primary-shari me-2"></i>
                ä½ å¥½ï¼Œ<span id="user-name">æœƒå“¡</span>ï¼
              </h1>
              <div id="status-badge-container">
                <span class="status-badge free">
                  <i class="fas fa-star"></i>
                  å…è²»æœƒå“¡
                </span>
              </div>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
              <button id="logout-btn" class="btn btn-outline-secondary">
                <i class="fas fa-sign-out-alt me-2"></i>
                ç™»å‡º
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- é ç´„é¡åº¦å¡ç‰‡ -->
    <section class="container py-2">
      <div class="card border-0 shadow-sm" id="credits-card">
        <div class="card-body p-4">
          <div class="row align-items-center g-4">
            <!-- å·¦å´ï¼šé¡åº¦é¡¯ç¤º -->
            <div class="col-md-6">
              <div class="d-flex align-items-center gap-3">
                <div class="icon-wrapper bg-primary bg-opacity-10 rounded-circle p-3">
                  <i class="fas fa-calendar-check fa-2x text-primary-shari"></i>
                </div>
                <div>
                  <h3 class="h5 mb-1">ä¸€å°ä¸€è¼”å°é ç´„</h3>
                  <p class="text-muted small mb-0">
                    å‰©é¤˜é»æ•¸ï¼š<strong id="credits-count" class="text-primary-shari fs-4">-</strong> æ¬¡
                  </p>
                </div>
              </div>
            </div>

            <!-- å³å´ï¼šå‹•ä½œæŒ‰éˆ• -->
            <div class="col-md-6 text-md-end">
              <button id="book-session-btn" class="btn btn-lg btn-primary-shari w-100 w-md-auto" onclick="handleBookClick()" disabled>
                <i class="fas fa-spinner fa-spin me-2"></i> è¼‰å…¥ä¸­...
              </button>
            </div>
          </div>

          <!-- ç‹€æ…‹è¨Šæ¯ -->
          <div id="no-credits-alert" class="alert alert-warning mt-3 d-none" role="alert">
            <i class="fas fa-info-circle me-2"></i>
            <strong>éœ€è¦è³¼è²·é ç´„é¡åº¦</strong>
            <p class="mb-2 small">æ¯æ¬¡ 50 åˆ†é˜çš„ä¸€å°ä¸€è¼”å°éœ€è¦ 1 å€‹é¡åº¦ï¼ˆ$33 USDï¼‰</p>
            <a id="buy-link" class="btn btn-sm btn-warning" target="_blank">
              <i class="fas fa-shopping-cart me-2"></i>
              è³¼è²· 1 æ¬¡è¼”å°ï¼ˆ$33ï¼‰
            </a>
          </div>

          <div id="has-credits-alert" class="alert alert-success mt-3 d-none" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <strong>æ‚¨å·²æ“æœ‰é ç´„é¡åº¦ï¼</strong>
            <p class="mb-0 small">é»æ“Šä¸Šæ–¹æŒ‰éˆ•å³å¯é ç´„ Shari çš„ä¸€å°ä¸€è¼”å°æ™‚æ®µ</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ä»˜æ¬¾ç´€éŒ„ -->
    <section class="container py-2">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-3">
          <h3 class="h5 mb-0">
            <i class="fas fa-receipt me-2"></i>
            ä»˜æ¬¾ç´€éŒ„
          </h3>
        </div>
        <div class="card-body">
          <div id="payments-list">
            <p class="text-muted text-center py-3">
              <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
              å°šç„¡ä»˜æ¬¾ç´€éŒ„
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- é ç´„ç´€éŒ„ -->
    <section class="container py-2 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-3">
          <h3 class="h5 mb-0">
            <i class="fas fa-history me-2"></i>
            é ç´„ç´€éŒ„
          </h3>
        </div>
        <div class="card-body">
          <div id="bookings-list">
            <p class="text-muted text-center py-3">
              <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
              å°šç„¡é ç´„ç´€éŒ„
            </p>
          </div>
        </div>
      </div>
    </section>
<footer class="bg-light border-top mt-auto py-4">
    <div
      class="container d-flex flex-column flex-md-row justify-content-between align-items-center text-center text-md-start">

      <!-- ç¤¾ç¾¤é€£çµ -->
      <div class="d-flex gap-3 my-3 my-md-0">
        <a href="https://www.instagram.com/uxshari/" class="social-link" aria-label="Instagram">
          <i class="fab fa-instagram"></i>
        </a>
        <a href="https://www.youtube.com/@uxshari" class="social-link" aria-label="YouTube">
          <i class="fab fa-youtube"></i>
        </a>
        <a href="https://www.linkedin.com/in/sharichung/" class="social-link" aria-label="LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
        <a href="https://join.slack.com/t/uxshari/shared_invite/zt-3ioqyosn8-p2VUz1ST9wceu8Io~2ovFQ" class="social-link"
          aria-label="Slack ç¤¾ç¾¤">
          <i class="fab fa-slack"></i>
        </a>
      </div>

      <!-- å¿«é€Ÿé€£çµ -->
      <div class="my-3 my-md-0">
        <a href="privacy.html" class="text-decoration-none text-muted me-3">éš±ç§æ¬Šæ”¿ç­–</a>
        <a href="terms.html" class="text-decoration-none text-muted me-3">ä½¿ç”¨è€…æ¢æ¬¾</a>
        <a href="contact.html" class="text-decoration-none text-muted">è¯çµ¡æˆ‘å€‘</a>
      </div>

      <!-- ç‰ˆæ¬Š -->
      <div class="mb-2 mb-md-0">
        <small class="text-muted">Â© <span id="current-year"></span> UXShari å­¸ç¿’å¹³å°. All rights reserved.</small>
      </div>
    </div>
  </footer>
</main>

  <!-- Footer -->
  

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Global function for book button (must be outside module scope) -->
  <script>
    console.log('ğŸ”µ Global script loaded - v20251117-1545');
    
    // Global flag to track if user has clicked book button
    window.hasClickedBookButton = false;
    
    window.handleBookClick = async function() {
      console.log('=== BUTTON CLICKED (GLOBAL FUNCTION) ===');
      
      const bookBtn = document.getElementById('book-session-btn');
      const hasCreditsAlert = document.getElementById('has-credits-alert');
      
      console.log('bookBtn:', bookBtn);
      console.log('hasCreditsAlert:', hasCreditsAlert);
      
      try {
        bookBtn.disabled = true;
        bookBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> æº–å‚™é ç´„é€£çµ...';
        
        console.log('Showing yellow warning...');
        window.hasClickedBookButton = true; // Set global flag
        
        hasCreditsAlert.classList.remove('alert-success', 'd-none');
        hasCreditsAlert.classList.add('alert-warning');
        hasCreditsAlert.innerHTML = `
          <i class="fas fa-hourglass-half me-2"></i>
          <strong>å·²é ç•™ 1 å€‹è¼”å°åé¡</strong>
          <p class="mb-0 small">è«‹åœ¨ <strong>10 åˆ†é˜å…§</strong>å®Œæˆ Calendly é ç´„è¡¨å–®ã€‚è‹¥æœªå®Œæˆï¼Œé»æ•¸å°‡è‡ªå‹•é€€å›ã€‚</p>
        `;
        console.log('Yellow warning displayed! Classes:', hasCreditsAlert.className);
        
        // Get auth from Firebase module (will be set by module script)
        console.log('Getting user email from Firebase auth...');
        const auth = window.firebaseAuth;
        if (!auth || !auth.currentUser) {
          throw new Error('ç”¨æˆ¶æœªç™»å…¥');
        }
        
        console.log('Fetching scheduling link for:', auth.currentUser.email);
        const workerBase = 'https://uxshari-workers.uxshari.workers.dev';
        const res = await fetch(`${workerBase}/api/create-scheduling-link?email=${encodeURIComponent(auth.currentUser.email)}`);
        const data = await res.json();
        
        console.log('API response:', data);
        
        if (!data.ok) throw new Error(data.error || 'å»ºç«‹é ç´„é€£çµå¤±æ•—');
        
        console.log('Opening Calendly link:', data.url);
        window.open(data.url, '_blank');
      } catch (e) {
        console.error('Error:', e);
        alert(e.message || 'ç„¡æ³•å»ºç«‹é ç´„é€£çµï¼Œè«‹ç¨å¾Œå†è©¦');
      } finally {
        bookBtn.disabled = false;
        bookBtn.innerHTML = '<i class="fas fa-calendar-check me-2"></i> ç«‹å³é ç´„ 50 åˆ†é˜è¼”å°';
      }
    };
  </script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyCZs2a35ENke7G8K7pzAMKCY3HOoi-IUcU",
      authDomain: "uxshari-670fd.firebaseapp.com",
      projectId: "uxshari-670fd",
      appId: "1:907540538791:web:ed98ef4ba51c96de43c282"
    };

    if (!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();
    
    // Expose auth to global scope for handleBookClick function
    window.firebaseAuth = auth;

    // å·¥å…·å‡½æ•¸
    const encEmail = (e) => btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
    const hideLoading = () => document.getElementById('loading-overlay').style.display = 'none';
    const showLoading = () => document.getElementById('loading-overlay').style.display = 'flex';

    // æ—¥æœŸè§£æèˆ‡æ ¼å¼åŒ–ï¼ˆå®¹éŒ¯è™•ç†ï¼‰
    function toDate(val) {
      try {
        if (!val) return null;
        if (val instanceof Date) return isNaN(val.getTime()) ? null : val;
        const t = typeof val;
        if (t === 'number') {
          const ms = val < 1e12 ? val * 1000 : val; // å¯èƒ½æ˜¯ç§’æˆ–æ¯«ç§’
          const d = new Date(ms);
          return isNaN(d.getTime()) ? null : d;
        }
        if (t === 'string') {
          const s = val.trim();
          if (/^\d+$/.test(s)) {
            const n = Number(s);
            return toDate(n);
          }
          const d = new Date(s);
          return isNaN(d.getTime()) ? null : d;
        }
        if (t === 'object') {
          // Firestore Timestamp æ ¼å¼
          if (typeof val.seconds === 'number') {
            const ms = val.seconds * 1000 + Math.floor((val.nanoseconds || 0) / 1e6);
            const d = new Date(ms);
            return isNaN(d.getTime()) ? null : d;
          }
          if (typeof val._seconds === 'number') {
            const ms = val._seconds * 1000 + Math.floor((val._nanoseconds || 0) / 1e6);
            const d = new Date(ms);
            return isNaN(d.getTime()) ? null : d;
          }
          if (typeof val.toDate === 'function') {
            try {
              const d = val.toDate();
              return isNaN(d?.getTime?.()) ? null : d;
            } catch {}
          }
        }
      } catch (_) {}
      return null;
    }

    function formatTW(val) {
      const d = toDate(val);
      if (!d) return 'æ—¥æœŸæœªçŸ¥';
      try {
        return d.toLocaleString('zh-TW', {
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit'
        });
      } catch {
        return d.toISOString();
      }
    }

    // é‡‘é¡é¡¯ç¤ºï¼ˆå®¹éŒ¯ï¼‰
    function formatAmount(pay) {
      const cur = (pay?.currency || 'USD').toUpperCase();
      let amt = null;
      if (typeof pay?.amount === 'number') amt = pay.amount;
      else if (typeof pay?.amount_total === 'number') amt = pay.amount_total / 100;
      else if (typeof pay?.amount_usd === 'number') amt = pay.amount_usd;
      else if (typeof pay?.unit_amount === 'number') amt = pay.unit_amount / 100;
      else if (typeof pay?.amount_cents === 'number') amt = pay.amount_cents / 100;
      else if (typeof pay?.price === 'number') amt = pay.price;
      const amtStr = (amt == null || Number.isNaN(amt)) ? '-' : Number(amt).toFixed(2);
      return { currency: cur, amountStr: amtStr };
    }

    // UI å…ƒç´ 
    const elements = {
      userName: document.getElementById('user-name'),
      statusBadge: document.getElementById('status-badge-container'),
      creditsCount: document.getElementById('credits-count'),
      creditsCard: document.getElementById('credits-card'),
      bookBtn: document.getElementById('book-session-btn'),
      buyLink: document.getElementById('buy-link'),
      noCreditsAlert: document.getElementById('no-credits-alert'),
      hasCreditsAlert: document.getElementById('has-credits-alert'),
      paymentsList: document.getElementById('payments-list'),
      bookingsList: document.getElementById('bookings-list'),
      logoutBtn: document.getElementById('logout-btn')
    };

    // ç™»å‡ºåŠŸèƒ½
    elements.logoutBtn.addEventListener('click', async () => {
      if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
        try {
          await signOut(auth);
          window.location.href = '/login.html';
        } catch (error) {
          console.error('ç™»å‡ºéŒ¯èª¤:', error);
          alert('ç™»å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦');
        }
      }
    });

    // Book button click handler - attached once on page load (backup, onclick is primary)
    elements.bookBtn.addEventListener('click', async () => {
      console.log('=== BUTTON CLICKED ===');
      console.log('Button disabled state:', elements.bookBtn.disabled);
      
      // Check if button is disabled (no credits)
      if (elements.bookBtn.disabled) {
        console.log('Button is disabled, ignoring click');
        return;
      }
      
      try {
        console.log('Starting book flow...');
        elements.bookBtn.disabled = true;
        elements.bookBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> æº–å‚™é ç´„é€£çµ...';
        console.log('Button text updated');
        
        console.log('Book button clicked, setting hasClickedBookButton to true');
        // Show warning message IMMEDIATELY when button is clicked
        window.hasClickedBookButton = true;
        console.log('hasClickedBookButton set to:', window.hasClickedBookButton);
        console.log('About to modify hasCreditsAlert...');
        console.log('hasCreditsAlert element:', elements.hasCreditsAlert);
        console.log('Current className:', elements.hasCreditsAlert.className);
        
        elements.hasCreditsAlert.classList.remove('alert-success', 'd-none');
        elements.hasCreditsAlert.classList.add('alert-warning');
        console.log('Classes modified, new className:', elements.hasCreditsAlert.className);
        
        elements.hasCreditsAlert.innerHTML = `
          <i class="fas fa-hourglass-half me-2"></i>
          <strong>å·²é ç•™ 1 å€‹è¼”å°åé¡</strong>
          <p class="mb-0 small">è«‹åœ¨ <strong>10 åˆ†é˜å…§</strong>å®Œæˆ Calendly é ç´„è¡¨å–®ã€‚è‹¥æœªå®Œæˆï¼Œé»æ•¸å°‡è‡ªå‹•é€€å›ã€‚</p>
        `;
        console.log('Warning message set, alert classes:', elements.hasCreditsAlert.className);
        console.log('innerHTML updated');
        
        console.log('Fetching scheduling link...');
        
        const workerBase = 'https://uxshari-workers.uxshari.workers.dev';
        const res = await fetch(`${workerBase}/api/create-scheduling-link?email=${encodeURIComponent(auth.currentUser.email)}`);
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'å»ºç«‹é ç´„é€£çµå¤±æ•—');
        
        console.log('Scheduling link created, opening in new tab');
        // Open link in new tab
        window.open(data.url, '_blank');
      } catch (e) {
        console.error('Error creating scheduling link:', e);
        alert(e.message || 'ç„¡æ³•å»ºç«‹é ç´„é€£çµï¼Œè«‹ç¨å¾Œå†è©¦');
        window.hasClickedBookButton = false; // Reset flag on error
        
        // Reset to success message on error
        elements.hasCreditsAlert.classList.remove('alert-warning');
        elements.hasCreditsAlert.classList.add('alert-success');
        elements.hasCreditsAlert.innerHTML = `
          <i class="fas fa-check-circle me-2"></i>
          <strong>æ‚¨å·²æ“æœ‰é ç´„é¡åº¦ï¼</strong>
          <p class="mb-0 small">é»æ“Šä¸Šæ–¹æŒ‰éˆ•å³å¯é ç´„ Shari çš„ä¸€å°ä¸€è¼”å°æ™‚æ®µ</p>
        `;
      } finally {
        // Only re-enable if there are still credits
        // Let updateUI handle the button state
      }
    });

    // æ›´æ–° UI
    function updateUI(userData) {
      const credits = userData?.credits ?? 0;
      const isPaid = userData?.isPaid ?? false;
      const payments = userData?.payments ?? [];
      const bookings = userData?.bookings ?? [];
      
      console.log('updateUI called, credits:', credits, 'hasClickedBookButton:', window.hasClickedBookButton);

      // æ›´æ–°é¡åº¦é¡¯ç¤ºï¼ˆå¸¶å‹•ç•«ï¼‰
      elements.creditsCount.textContent = credits;
      elements.creditsCard.classList.add('credits-updated');
      setTimeout(() => elements.creditsCard.classList.remove('credits-updated'), 500);

      // æ›´æ–°æœƒå“¡ç‹€æ…‹å¾½ç« 
      if (isPaid) {
        elements.statusBadge.innerHTML = `
          <span class="status-badge paid">
            <i class="fas fa-crown"></i>
            ä»˜è²»æœƒå“¡
          </span>
        `;
      } else {
        elements.statusBadge.innerHTML = `
          <span class="status-badge free">
            <i class="fas fa-star"></i>
            å…è²»æœƒå“¡
          </span>
        `;
      }

      // æ›´æ–°é ç´„æŒ‰éˆ•
      if (credits > 0) {
        elements.bookBtn.disabled = false;
        elements.bookBtn.innerHTML = '<i class="fas fa-calendar-check me-2"></i> ç«‹å³é ç´„ 50 åˆ†é˜è¼”å°';
        elements.noCreditsAlert.classList.add('d-none');
        
        // Show appropriate message based on whether user has clicked book
        if (window.hasClickedBookButton) {
          console.log('Showing warning message because hasClickedBookButton is true');
          // Keep showing warning message
          elements.hasCreditsAlert.classList.remove('alert-success', 'd-none');
          elements.hasCreditsAlert.classList.add('alert-warning');
          elements.hasCreditsAlert.innerHTML = `
            <i class="fas fa-hourglass-half me-2"></i>
            <strong>å·²é ç•™ 1 å€‹è¼”å°åé¡</strong>
            <p class="mb-0 small">è«‹åœ¨ <strong>10 åˆ†é˜å…§</strong>å®Œæˆ Calendly é ç´„è¡¨å–®ã€‚è‹¥æœªå®Œæˆï¼Œé»æ•¸å°‡è‡ªå‹•é€€å›ã€‚</p>
          `;
        } else {
          console.log('Showing success message because hasClickedBookButton is false');
          // Show default success message
          elements.hasCreditsAlert.classList.remove('alert-warning', 'd-none');
          elements.hasCreditsAlert.classList.add('alert-success');
          elements.hasCreditsAlert.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            <strong>æ‚¨å·²æ“æœ‰é ç´„é¡åº¦ï¼</strong>
            <p class="mb-0 small">é»æ“Šä¸Šæ–¹æŒ‰éˆ•å³å¯é ç´„ Shari çš„ä¸€å°ä¸€è¼”å°æ™‚æ®µ</p>
          `;
        }
      } else {
        elements.bookBtn.disabled = true;
        elements.bookBtn.innerHTML = '<i class="fas fa-lock me-2"></i> éœ€å…ˆè³¼è²·é ç´„é¡åº¦';
        elements.noCreditsAlert.classList.remove('d-none');
        elements.hasCreditsAlert.classList.add('d-none');
      }

      // æ›´æ–°ä»˜æ¬¾ç´€éŒ„
      if (payments.length > 0) {
        elements.paymentsList.innerHTML = payments.slice().reverse().map(p => {
          const { currency, amountStr } = formatAmount(p);
          return `
          <div class="d-flex justify-content-between align-items-center border-bottom py-3">
            <div>
              <div class="fw-bold">${currency} $${amountStr}</div>
              <div class="small text-muted">${formatTW(p.createdAt)}</div>
              ${p.receiptUrl ? `<a class=\"small\" href=\"${p.receiptUrl}\" target=\"_blank\">æŸ¥çœ‹æ”¶æ“š</a>` : ''}
            </div>
            <span class="badge bg-success">å·²å®Œæˆ</span>
          </div>
          `;
        }).join('');
      }

      // æ›´æ–°é ç´„ç´€éŒ„
      if (bookings.length > 0) {
        elements.bookingsList.innerHTML = bookings.slice().reverse().map(b => {
          const status = b.status || 'scheduled';
          const dateSource = b.startAt || b.start_time || b.scheduledAt || b.eventStart || b.confirmedAt || b.createdAt || b.canceledAt;
          const formattedDate = formatTW(dateSource);
          const badgeCls = status === 'canceled' ? 'bg-secondary' : 'bg-primary';
          const badgeText = status === 'canceled' ? 'å·²å–æ¶ˆ' : 'å·²é ç´„';
          return `
            <div class="d-flex justify-content-between align-items-center border-bottom py-3">
              <div>
                <div class="fw-bold">ä¸€å°ä¸€è¼”å° (50 åˆ†é˜)</div>
                <div class="small text-muted">${formattedDate}</div>
              </div>
              <span class="badge ${badgeCls}">${badgeText}</span>
            </div>
          `;
        }).join('');
      }
    }

    // ç›£è½èªè­‰ç‹€æ…‹
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        hideLoading();
        window.location.href = '/login.html';
        return;
      }

      // æ›´æ–°ç”¨æˆ¶åç¨±
      elements.userName.textContent = user.displayName || user.email?.split('@')[0] || 'æœƒå“¡';

      // æ›´æ–°è³¼è²·é€£çµï¼ˆé å¡« emailï¼‰
      if (user.email) {
        const workerBase = 'https://uxshari-workers.uxshari.workers.dev';
        elements.buyLink.href = `${workerBase}/api/checkout-redirect?email=${encodeURIComponent(user.email)}&origin=${encodeURIComponent(location.origin)}`;
        elements.buyLink.target = '_self';
      }

      // è®€å– Firestore è³‡æ–™ï¼ˆå³æ™‚ç›£è½ï¼‰
      if (user.email) {
        const docRef = doc(db, "users_by_email", encEmail(user.email));
        
        // ä½¿ç”¨ onSnapshot å¯¦ç¾å³æ™‚æ›´æ–°
        onSnapshot(docRef, (snapshot) => {
          hideLoading();
          if (snapshot.exists()) {
            updateUI(snapshot.data());
          } else {
            updateUI({});
          }
        }, (error) => {
          console.error('Firestore ç›£è½éŒ¯èª¤:', error);
          hideLoading();
          alert('ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
        });
      } else {
        hideLoading();
      }
    });
  </script>

  <!-- Test Private Key -->
  <script>
    // åœ¨ç€è¦½å™¨ Console æ¸¬è©¦
    const testKey = `-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC...
-----END PRIVATE KEY-----`;

    const cleaned = testKey
      .replace(/-----BEGIN PRIVATE KEY-----/g, "")
      .replace(/-----END PRIVATE KEY-----/g, "")
      .replace(/\n/g, "")
      .replace(/\s+/g, "");

    console.log("Length:", cleaned.length);
    console.log("Valid base64:", /^[A-Za-z0-9+/]*={0,2}$/.test(cleaned));
  </script>

</body>
</html>
