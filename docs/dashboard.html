<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UXShari æœƒå“¡å°ˆå€ | å­¸ç¿’å„€è¡¨æ¿</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="assets/css/general.css">
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&amp;family=Tektur:wght@400;500;600;700&amp;display=swap"
    rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">

  <script src="assets/js/clarity.js" defer></script>

  </head>
<body class="min-vh-100 d-flex flex-column bg-light">

  <!-- Loading Spinner -->
  <div id="loading-overlay" class="spinner-overlay">
    <div class="text-center">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
      </div>
      <p class="mt-3 text-muted">è¼‰å…¥æ‚¨çš„è³‡æ–™...</p>
    </div>
  </div>

  <!-- Navbar -->
  <div id="navbar"><nav id="mainNavbar"
    class="fade-in-down navbar-general navbar navbar-expand-lg position-fixed top-0 start-0 end-0 px-3 py-2 bg-white shadow-sm transition"
    style="z-index: 1030;">
    <div class="container">
      <!-- Brand -->
      <a href="dashboard.html"
         class="enter-fadein logo futuristic-hover navbar-brand d-flex align-items-center me-auto py-0"
         aria-label="Dashboard" title="Dashboard">
        <svg viewBox="0 0 570 119" preserveAspectRatio="xMidYMid meet" role="img" aria-hidden="true" focusable="false"
         style="height: clamp(24px, 3.5vw, 36px); width: auto; display: block;">
          <g clip-path="url(#a)">
        <path d="M78.15 0c.22.16 2.4 4.5 2.11 4.9-24.13 9.75-42.1 34.7-24.01 59.01 4.7-10.74 14.88-18.65 26.01-21.99-4.49 10.14-10.81 17.16-6.47 28.97 6.19 16.81 29.73 11.03 42.45 6.52-11.11 15.18-30.3 29.07-50.2 23.23-10.07-2.96-12.51-9.93-16.28-18.69L5.61 117.76c-2.49 2.57-6.95.26-5.23-2.73.3-.52 8.01-4.95 9.89-6.6C29.62 91.39 29.78 74.9 18.78 52.9c-1.09-2.18-5.99-8.31-5.1-9.98z" fill="#fe8a02"/>
        <path d="M374.26 23.92v14h-38v14l39 3v30.5c0 .67-8.83 9.5-9.5 9.5h-43.5v-13h38v-16l-39-3v-28.5c0-.74 9.76-10.5 10.5-10.5zm-195 57h25v-55.5c0-2.56 12.56-1.17 15-1.5v60.5c0 .67-8.84 9.21-9.45 9.55-1.67.96-2.24.83-3.99 1.01-4.43.44-27.69.68-30.86-.27-.71-.21-10.7-9.55-10.7-10.3V23.92c2.44.33 15-1.06 15 1.5zm108-57c1.94 1.97-13.34 29.22-13.74 34.36l15.74 36.64h-15.5c-3.32-3.81-10.35-27.86-13.16-28.83-1.34-.46-5.34-.46-6.68 0-2.8.97-9.84 25.03-13.16 28.83h-15.5L241 58.28c-3.26-11.84-11.42-22.47-13.74-34.36h14.5c.62 0 1.95 2.84 2.37 3.63 3.23 5.92 5.74 17.97 9.21 22.79 1.43 1.99 4.16 2.12 6.25 1.43 3.1-1.03 10.78-27.84 13.16-27.84h14.5zm113 0v14h25.5c.81 0 11.5 10.69 11.5 11.5v45.5h-15v-44h-22v44h-15v-71zm97 71h-40.5c-.74 0-10.5-9.76-10.5-10.5v-22.5l36-1v-10h-34v-13h37.5c.81 0 11.5 10.69 11.5 11.5zm-36-12h21v-13c-3.07.41-19.89.94-20.89 2.11-.74.86.3 8.85-.11 10.89m86-45v14h-25v43h-15v-45.5c0-.81 10.69-11.5 11.5-11.5zm22 0h-15v57h15zm0-5h-15V21.91c11.27.35 16.98-3.57 15 11.01" fill="#060606"/>
          </g>
          <defs>
        <clipPath id="a"><path fill="#fff" d="M0 0h569.65v118.87H0z"/></clipPath>
          </defs>
        </svg>
      </a>


      <a class="d-flex align-items-center text-dark text-decoration-none" href="account.html" role="button">
        <img src="" alt="User Avatar" class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover;" id="userAvatar">
      </a>
      
      <script>
        // Load user avatar from account
        document.addEventListener('DOMContentLoaded', function() {
          const avatar = localStorage.getItem('userAvatar') || sessionStorage.getItem('userAvatar');
          const avatarImg = document.getElementById('userAvatar');
          
          if (avatar) {
        avatarImg.src = avatar;
          } else {
        // Fallback to default icon if no avatar is saved
        avatarImg.outerHTML = '<i class="fas fa-user-circle text-dark" role="img" aria-label="æœƒå“¡å¸³è™Ÿ" style="font-size: 32px;"></i>';
          }
        });
      </script>
    </div>
  </nav>

  <script>
    window.addEventListener('scroll', function () {
      const navbar = document.getElementById('mainNavbar');
      if (window.scrollY > 10) {
        navbar.classList.add('navbar-scrolled');
      } else {
        navbar.classList.remove('navbar-scrolled');
      }
    });
  </script>
</div>

  <!-- Main Content -->
  <main class="flex-grow-1 d-flex flex-column" style="padding-top:80px;">
    
    <!-- æœƒå“¡ç‹€æ…‹æ©«å¹… -->
    <section class="container py-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h1 class="h4 mb-2">
                <i class="fas fa-user-circle text-primary-shari me-2"></i>
                ä½ å¥½ï¼Œ<span id="user-name">æœƒå“¡</span>ï¼
              </h1>
              <div id="status-badge-container">
                <span class="status-badge free">
                  <i class="fas fa-star"></i>
                  å…è²»æœƒå“¡
                </span>
              </div>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
              <button id="logout-btn" class="btn btn-outline-secondary">
                <i class="fas fa-sign-out-alt me-2"></i>
                ç™»å‡º
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- é ç´„é¡åº¦å¡ç‰‡ -->
    <section class="container py-2">
      <div class="card border-0 shadow-sm" id="credits-card">
        <div class="card-body p-4">
          <div class="row align-items-center g-4">
            <!-- å·¦å´ï¼šé¡åº¦é¡¯ç¤º -->
            <div class="col-md-6">
              <div class="d-flex align-items-center gap-3">
                <div class="icon-wrapper bg-primary bg-opacity-10 rounded-circle p-3">
                  <i class="fas fa-calendar-check fa-2x text-primary-shari"></i>
                </div>
                <div>
                  <h3 class="h5 mb-1">ä¸€å°ä¸€è¼”å°é ç´„</h3>
                  <p class="text-muted small mb-0">
                    å‰©é¤˜é»æ•¸ï¼š<strong id="credits-count" class="text-primary-shari fs-4">-</strong> æ¬¡
                  </p>
                </div>
              </div>
            </div>

            <!-- å³å´ï¼šå‹•ä½œæŒ‰éˆ• -->
            <div class="col-md-6 text-md-end">
              <button id="book-session-btn" class="btn btn-lg btn-primary-shari w-100 w-md-auto" disabled>
                <i class="fas fa-spinner fa-spin me-2"></i> è¼‰å…¥ä¸­...
              </button>
            </div>
          </div>

          <!-- ç‹€æ…‹è¨Šæ¯ -->
          <div id="no-credits-alert" class="alert alert-warning mt-3 d-none" role="alert">
            <i class="fas fa-info-circle me-2"></i>
            <strong>éœ€è¦è³¼è²·é ç´„é¡åº¦</strong>
            <p class="mb-2 small">æ¯æ¬¡ 50 åˆ†é˜çš„ä¸€å°ä¸€è¼”å°éœ€è¦ 1 å€‹é¡åº¦ï¼ˆ$33 USDï¼‰</p>
            <a id="buy-link" class="btn btn-sm btn-warning" target="_blank">
              <i class="fas fa-shopping-cart me-2"></i>
              è³¼è²· 1 æ¬¡è¼”å°ï¼ˆ$33ï¼‰
            </a>
          </div>

          <div id="has-credits-alert" class="alert alert-success mt-3 d-none" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <strong>æ‚¨å·²æ“æœ‰é ç´„é¡åº¦ï¼</strong>
            <p class="mb-0 small">é»æ“Šä¸Šæ–¹æŒ‰éˆ•å³å¯é ç´„ Shari çš„ä¸€å°ä¸€è¼”å°æ™‚æ®µ</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ä»˜æ¬¾ç´€éŒ„ -->
    <section class="container py-2">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-3">
          <h3 class="h5 mb-0">
            <i class="fas fa-receipt me-2"></i>
            ä»˜æ¬¾ç´€éŒ„
          </h3>
        </div>
        <div class="card-body">
          <div id="payments-list">
            <p class="text-muted text-center py-3">
              <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
              å°šç„¡ä»˜æ¬¾ç´€éŒ„
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- é ç´„ç´€éŒ„ -->
    <section class="container py-2 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-3">
          <h3 class="h5 mb-0">
            <i class="fas fa-history me-2"></i>
            é ç´„ç´€éŒ„
          </h3>
        </div>
        <div class="card-body text-center py-4">
          <i class="fas fa-calendar-alt fa-3x text-primary-shari mb-3"></i>
          <h5 class="mb-2">åœ¨ Calendly ç®¡ç†æ‚¨çš„é ç´„</h5>
          <p class="text-muted mb-3">
            æŸ¥çœ‹ã€é‡æ–°å®‰æ’æˆ–å–æ¶ˆæ‚¨çš„é ç´„æ™‚æ®µ
          </p>
          <a href="https://calendly.com/app/scheduled_events/user/me" 
             target="_blank" 
             class="btn btn-primary-shari">
            <i class="fas fa-external-link-alt me-2"></i>
            å‰å¾€ Calendly æŸ¥çœ‹é ç´„
          </a>
        </div>
      </div>
    </section>

    <!-- ğŸ›ï¸ æ•¸ä½ç”¢å“å•†åº— -->
    <section class="container py-2 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
          <h3 class="h5 mb-0">
            <i class="fas fa-store me-2"></i>
            æ•¸ä½ç”¢å“å•†åº—
          </h3>
          <div class="btn-group btn-group-sm" role="group" id="product-filter-buttons">
            <button type="button" class="btn btn-outline-primary active" data-filter="all">å…¨éƒ¨</button>
            <button type="button" class="btn btn-outline-primary" data-filter="tool">ğŸ§° å·¥å…·</button>
            <button type="button" class="btn btn-outline-primary" data-filter="course">ğŸ“š èª²ç¨‹</button>
            <button type="button" class="btn btn-outline-primary" data-filter="challenge">ğŸ¯ æŒ‘æˆ°</button>
            <button type="button" class="btn btn-outline-primary" data-filter="resource">ğŸ“¦ è³‡æº</button>
          </div>
        </div>
        <div class="card-body">
          <!-- æœå°‹åˆ— -->
          <div class="mb-4">
            <div class="input-group">
              <span class="input-group-text bg-white">
                <i class="fas fa-search text-muted"></i>
              </span>
              <input type="text" class="form-control" id="product-search" 
                     placeholder="æœå°‹ç”¢å“åç¨±ã€é¡åˆ¥æˆ–æ¨™ç±¤...">
            </div>
          </div>

          <!-- ç”¢å“å¡ç‰‡ç¶²æ ¼ -->
          <div id="products-grid" class="row g-4">
            <!-- è¼‰å…¥ä¸­ç‹€æ…‹ -->
            <div class="col-12 text-center py-5" id="products-loading">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
              </div>
              <p class="text-muted mt-3">æ­£åœ¨è¼‰å…¥ç”¢å“...</p>
            </div>
            
            <!-- ç©ºç‹€æ…‹ -->
            <div class="col-12 text-center py-5 d-none" id="products-empty">
              <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">æš«ç„¡ç”¢å“</h5>
              <p class="text-muted small">æ•¬è«‹æœŸå¾…æ›´å¤šç²¾å½©å…§å®¹</p>
            </div>
          </div>
        </div>
      </div>
    </section>

<footer class="bg-light border-top mt-auto py-4">
    <div
      class="container d-flex flex-column flex-md-row justify-content-between align-items-center text-center text-md-start">

      <!-- ç¤¾ç¾¤é€£çµ -->
      <div class="d-flex gap-3 my-3 my-md-0">
        <a href="https://www.instagram.com/uxshari/" class="social-link" aria-label="Instagram">
          <i class="fab fa-instagram"></i>
        </a>
        <a href="https://www.youtube.com/@uxshari" class="social-link" aria-label="YouTube">
          <i class="fab fa-youtube"></i>
        </a>
        <a href="https://www.linkedin.com/in/sharichung/" class="social-link" aria-label="LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
        <a href="https://join.slack.com/t/uxshari/shared_invite/zt-3ioqyosn8-p2VUz1ST9wceu8Io~2ovFQ" class="social-link"
          aria-label="Slack ç¤¾ç¾¤">
          <i class="fab fa-slack"></i>
        </a>
      </div>

      <!-- å¿«é€Ÿé€£çµ -->
      <div class="my-3 my-md-0">
        <a href="privacy.html" class="text-decoration-none text-muted me-3">éš±ç§æ¬Šæ”¿ç­–</a>
        <a href="terms.html" class="text-decoration-none text-muted me-3">ä½¿ç”¨è€…æ¢æ¬¾</a>
        <a href="contact.html" class="text-decoration-none text-muted">è¯çµ¡æˆ‘å€‘</a>
      </div>

      <!-- ç‰ˆæ¬Š -->
      <div class="mb-2 mb-md-0">
        <small class="text-muted">Â© <span id="current-year"></span> UXShari å­¸ç¿’å¹³å°. All rights reserved.</small>
      </div>
    </div>
  </footer>
</main>

  <!-- Footer -->
  

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase SDK + Dashboard Logic -->
  <script type="module" src="assets/js/pages/dashboard.js"></script>
    console.log("ğŸŸ¢ [DASHBOARD-OPT] Script loaded - v20251117-2210-FILTER-FIX");
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyCZs2a35ENke7G8K7pzAMKCY3HOoi-IUcU",
      authDomain: "uxshari-670fd.firebaseapp.com",
      projectId: "uxshari-670fd",
      appId: "1:907540538791:web:ed98ef4ba51c96de43c282"
    };

    if (!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    // å·¥å…·å‡½æ•¸
    const encEmail = (e) => btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
    const hideLoading = () => document.getElementById('loading-overlay').style.display = 'none';
    const showLoading = () => document.getElementById('loading-overlay').style.display = 'flex';

    // æ—¥æœŸè§£æèˆ‡æ ¼å¼åŒ–ï¼ˆå®¹éŒ¯è™•ç†ï¼‰
    function toDate(val) {
      try {
        if (!val) return null;
        if (val instanceof Date) return isNaN(val.getTime()) ? null : val;
        const t = typeof val;
        if (t === 'number') {
          const ms = val < 1e12 ? val * 1000 : val; // å¯èƒ½æ˜¯ç§’æˆ–æ¯«ç§’
          const d = new Date(ms);
          return isNaN(d.getTime()) ? null : d;
        }
        if (t === 'string') {
          const s = val.trim();
          if (/^\d+$/.test(s)) {
            const n = Number(s);
            return toDate(n);
          }
          const d = new Date(s);
          return isNaN(d.getTime()) ? null : d;
        }
        if (t === 'object') {
          if (typeof val.seconds === 'number') {
            const ms = val.seconds * 1000 + Math.floor((val.nanoseconds || 0) / 1e6);
            const d = new Date(ms);
            return isNaN(d.getTime()) ? null : d;
          }
          if (typeof val._seconds === 'number') {
            const ms = val._seconds * 1000 + Math.floor((val._nanoseconds || 0) / 1e6);
            const d = new Date(ms);
            return isNaN(d.getTime()) ? null : d;
          }
          if (typeof val.toDate === 'function') {
            try {
              const d = val.toDate();
              return isNaN(d?.getTime?.()) ? null : d;
            } catch {}
          }
        }
      } catch (_) {}
      return null;
    }

    function formatTW(val) {
      const d = toDate(val);
      if (!d) return 'æ—¥æœŸæœªçŸ¥';
      try {
        return d.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
      } catch {
        return d.toISOString();
      }
    }

    // é‡‘é¡é¡¯ç¤ºï¼ˆå®¹éŒ¯ï¼‰
    function formatAmount(pay) {
      const cur = (pay?.currency || 'USD').toUpperCase();
      let amt = null;
      if (typeof pay?.amount === 'number') amt = pay.amount;
      else if (typeof pay?.amount_total === 'number') amt = pay.amount_total / 100;
      else if (typeof pay?.amount_usd === 'number') amt = pay.amount_usd;
      else if (typeof pay?.unit_amount === 'number') amt = pay.unit_amount / 100;
      else if (typeof pay?.amount_cents === 'number') amt = pay.amount_cents / 100;
      else if (typeof pay?.price === 'number') amt = pay.price;
      const amtStr = (amt == null || Number.isNaN(amt)) ? '-' : Number(amt).toFixed(2);
      return { currency: cur, amountStr: amtStr };
    }

    // UI å…ƒç´ 
    const elements = {
      userName: document.getElementById('user-name'),
      statusBadge: document.getElementById('status-badge-container'),
      creditsCount: document.getElementById('credits-count'),
      creditsCard: document.getElementById('credits-card'),
      bookBtn: document.getElementById('book-session-btn'),
      buyLink: document.getElementById('buy-link'),
      noCreditsAlert: document.getElementById('no-credits-alert'),
      hasCreditsAlert: document.getElementById('has-credits-alert'),
      paymentsList: document.getElementById('payments-list'),
      logoutBtn: document.getElementById('logout-btn')
    };

    // ç™»å‡ºåŠŸèƒ½
    elements.logoutBtn.addEventListener('click', async () => {
      if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
        try {
          await signOut(auth);
          window.location.href = '/index.html';
        } catch (error) {
          console.error('ç™»å‡ºéŒ¯èª¤:', error);
          alert('ç™»å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦');
        }
      }
    });

    // æ›´æ–° UI
    function updateUI(userData) {
      console.log("ğŸ“Š [DASHBOARD-OPT] updateUI è¢«å‘¼å«ï¼Œå®Œæ•´è³‡æ–™ï¼š", userData);
      const credits = userData?.credits ?? 0;
      const isPaid = userData?.isPaid ?? false;
      const payments = userData?.payments ?? [];
      console.log("ğŸ“… [DASHBOARD-OPT] è§£æçµæœ - credits:", credits, "payments:", payments.length);

      // æ›´æ–°é¡åº¦é¡¯ç¤ºï¼ˆå¸¶å‹•ç•«ï¼‰
      elements.creditsCount.textContent = credits;
      elements.creditsCard.classList.add('credits-updated');
      setTimeout(() => elements.creditsCard.classList.remove('credits-updated'), 500);

      // æ›´æ–°æœƒå“¡ç‹€æ…‹å¾½ç« 
      if (isPaid) {
        elements.statusBadge.innerHTML = `
          <span class="status-badge paid">
            <i class="fas fa-crown"></i>
            ä»˜è²»æœƒå“¡
          </span>
        `;
      } else {
        elements.statusBadge.innerHTML = `
          <span class="status-badge free">
            <i class="fas fa-star"></i>
            å…è²»æœƒå“¡
          </span>
        `;
      }

      // æ›´æ–°é ç´„æŒ‰éˆ•
      if (credits > 0) {
        elements.bookBtn.disabled = false;
        elements.bookBtn.innerHTML = '<i class="fas fa-calendar-check me-2"></i> ç«‹å³é ç´„ 50 åˆ†é˜è¼”å°';
        elements.bookBtn.onclick = async () => {
          try {
            elements.bookBtn.disabled = true;
            elements.bookBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> æº–å‚™é ç´„é€£çµ...';
            const workerBase = 'https://uxshari-workers.uxshari.workers.dev';
            const res = await fetch(`${workerBase}/api/create-scheduling-link?email=${encodeURIComponent(auth.currentUser.email)}`);
            const data = await res.json();
            if (!data.ok) throw new Error(data.error || 'å»ºç«‹é ç´„é€£çµå¤±æ•—');
            window.open(data.url, '_blank');
          } catch (e) {
            alert(e.message || 'ç„¡æ³•å»ºç«‹é ç´„é€£çµï¼Œè«‹ç¨å¾Œå†è©¦');
          } finally {
            elements.bookBtn.disabled = false;
            elements.bookBtn.innerHTML = '<i class="fas fa-calendar-check me-2"></i> ç«‹å³é ç´„ 50 åˆ†é˜è¼”å°';
          }
        };
        elements.noCreditsAlert.classList.add('d-none');
        elements.hasCreditsAlert.classList.remove('d-none');
      } else {
        elements.bookBtn.disabled = true;
        elements.bookBtn.innerHTML = '<i class="fas fa-lock me-2"></i> éœ€å…ˆè³¼è²·é ç´„é¡åº¦';
        elements.noCreditsAlert.classList.remove('d-none');
        elements.hasCreditsAlert.classList.add('d-none');
      }

      // æ›´æ–°ä»˜æ¬¾ç´€éŒ„
      if (payments.length > 0) {
        elements.paymentsList.innerHTML = payments.slice().reverse().map(p => {
          const { currency, amountStr } = formatAmount(p);
          return `
          <div class="d-flex justify-content-between align-items-center border-bottom py-3">
            <div>
              <div class="fw-bold">${currency} $${amountStr}</div>
              <div class="small text-muted">${formatTW(p.createdAt)}</div>
              ${p.receiptUrl ? `<a class="small" href="${p.receiptUrl}" target="_blank">æŸ¥çœ‹æ”¶æ“š</a>` : ''}
            </div>
            <span class="badge bg-success">å·²å®Œæˆ</span>
          </div>
          `;
        }).join('');
      }
    }

    // ç›£è½èªè­‰ç‹€æ…‹
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        hideLoading();
        window.location.href = '/index.html';
        return;
      }

      // æ›´æ–°ç”¨æˆ¶åç¨±
      elements.userName.textContent = user.displayName || user.email?.split('@')[0] || 'æœƒå“¡';

      // æ›´æ–°è³¼è²·é€£çµï¼ˆé å¡« emailï¼‰
      if (user.email) {
        const workerBase = 'https://uxshari-workers.uxshari.workers.dev';
        elements.buyLink.href = `${workerBase}/api/checkout-redirect?email=${encodeURIComponent(user.email)}&origin=${encodeURIComponent(location.origin)}`;
        elements.buyLink.target = '_self';
      }

      // è®€å– Firestore è³‡æ–™ï¼ˆå³æ™‚ç›£è½ï¼‰
      if (user.email) {
        const docRef = doc(db, "users_by_email", encEmail(user.email));
        console.log("ğŸ” [DASHBOARD-OPT] é–‹å§‹ç›£è½ Firestoreï¼š", `users_by_email/${encEmail(user.email)}`);
        
        // ä½¿ç”¨ onSnapshot å¯¦ç¾å³æ™‚æ›´æ–°
        onSnapshot(docRef, (snapshot) => {
          hideLoading();
          console.log("ğŸ“© [DASHBOARD-OPT] Firestore snapshot æ”¶åˆ°ï¼Œexists:", snapshot.exists());
          if (snapshot.exists()) {
            const data = snapshot.data();
            console.log("âœ… [DASHBOARD-OPT] Firestore å®Œæ•´è³‡æ–™ï¼š", data);
            updateUI(data);
          } else {
            console.warn("âš ï¸ [DASHBOARD-OPT] Firestore æ–‡æª”ä¸å­˜åœ¨");
            updateUI({});
          }
        }, (error) => {
          console.error('âŒ [DASHBOARD-OPT] Firestore ç›£è½éŒ¯èª¤:', error);
          hideLoading();
          alert('ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
        });
      } else {
        hideLoading();
      }
    });

    // ============================================================
    // ğŸ›ï¸ ç”¢å“å•†åº—åŠŸèƒ½
    // ============================================================
    const WORKER_BASE = 'https://uxshari-workers.uxshari.workers.dev';
    let allProducts = [];
    let userPurchasedProducts = [];
    let currentFilter = 'all';

    // ç”¢å“é¡å‹åœ–æ¨™å’Œé¡¯ç¤ºåç¨±
    const productTypeConfig = {
      tool: { icon: 'ğŸ§°', name: 'å·¥å…·', class: 'product-type-tool' },
      course: { icon: 'ğŸ“š', name: 'èª²ç¨‹', class: 'product-type-course' },
      challenge: { icon: 'ğŸ¯', name: 'æŒ‘æˆ°', class: 'product-type-challenge' },
      resource: { icon: 'ğŸ“¦', name: 'è³‡æº', class: 'product-type-resource' }
    };

    // è¼‰å…¥ç”¢å“åˆ—è¡¨
    async function loadProducts() {
      try {
        const response = await fetch(`${WORKER_BASE}/api/products?active=true`);
        const data = await response.json();
        
        if (data.ok) {
          allProducts = data.products;
          renderProducts();
        } else {
          throw new Error(data.error || 'è¼‰å…¥ç”¢å“å¤±æ•—');
        }
      } catch (error) {
        console.error('âŒ è¼‰å…¥ç”¢å“éŒ¯èª¤:', error);
        document.getElementById('products-loading').innerHTML = `
          <div class="text-center text-danger">
            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
            <p>è¼‰å…¥ç”¢å“å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p>
          </div>
        `;
      }
    }

    // è¼‰å…¥ä½¿ç”¨è€…å·²è³¼ç”¢å“
    async function loadUserPurchases(email) {
      try {
        const response = await fetch(`${WORKER_BASE}/api/user/purchased-products?email=${encodeURIComponent(email)}`);
        const data = await response.json();
        
        if (data.ok) {
          userPurchasedProducts = data.purchasedProducts || [];
          // Only render if products have been loaded
          if (allProducts.length > 0) {
            renderProducts();
          }
        }
      } catch (error) {
        console.error('âŒ è¼‰å…¥è³¼è²·ç´€éŒ„éŒ¯èª¤:', error);
      }
    }

    // æª¢æŸ¥ç”¢å“æ˜¯å¦å·²è³¼è²·
    function isPurchased(productId) {
      return userPurchasedProducts.some(p => p.productId === productId);
    }

    // ç²å–ç”¢å“é€²åº¦
    function getProductProgress(productId) {
      const purchase = userPurchasedProducts.find(p => p.productId === productId);
      return purchase?.progress || null;
    }

    // æ¸²æŸ“ç”¢å“å¡ç‰‡
    function renderProducts() {
      const grid = document.getElementById('products-grid');
      const loading = document.getElementById('products-loading');
      const empty = document.getElementById('products-empty');
      const searchInput = document.getElementById('product-search');
      
      if (!grid || !loading || !empty || !searchInput) {
        console.error('âŒ Required DOM elements not found');
        return;
      }
      
      const searchTerm = searchInput.value.toLowerCase();

      // ç¯©é¸ç”¢å“
      let filtered = allProducts.filter(p => {
        const matchFilter = currentFilter === 'all' || p.type === currentFilter;
        const matchSearch = !searchTerm || 
          p.title.toLowerCase().includes(searchTerm) ||
          p.description.toLowerCase().includes(searchTerm) ||
          (p.tags || []).some(tag => tag.toLowerCase().includes(searchTerm));
        return matchFilter && matchSearch;
      });

      loading.classList.add('d-none');

      if (filtered.length === 0) {
        empty.classList.remove('d-none');
        // Clear grid but keep empty state visible as a child of products-grid parent
        const gridParent = grid.parentElement;
        if (gridParent && !gridParent.contains(empty)) {
          // Empty is already a sibling in the HTML, just ensure visibility
        }
        grid.innerHTML = '';
        return;
      }

      empty.classList.add('d-none');
      
      // æ¸²æŸ“å¡ç‰‡
      grid.innerHTML = filtered.map(product => {
        const config = productTypeConfig[product.type] || productTypeConfig.tool;
        const purchased = isPurchased(product.id);
        const progress = getProductProgress(product.id);
        const progressPercent = progress ? Math.round((progress.completedUnits.length / progress.totalUnits) * 100) : 0;

        return `
          <div class="col-md-6 col-lg-4">
            <div class="product-card" data-product-id="${product.id}">
              <div class="position-relative product-card-image-wrapper">
                <img src="${product.coverImage || 'https://images.unsplash.com/photo-1558655146-364adaf1fcc9?w=1200&h=800&fit=crop'}" 
                     class="product-card-image" 
                     alt="${product.title}"
                     loading="lazy"
                     onerror="this.src='https://images.unsplash.com/photo-1558655146-364adaf1fcc9?w=1200&h=800&fit=crop'">
                <span class="product-badge ${purchased ? 'unlocked' : 'locked'}">
                  <i class="fas ${purchased ? 'fa-check-circle' : 'fa-lock'} me-1"></i>
                  ${purchased ? 'å·²è§£é–' : '$' + product.price}
                </span>
              </div>
              
              <div class="p-3 flex-grow-1 d-flex flex-column">
                <div class="${config.class} product-type-icon">
                  ${config.icon}
                </div>
                
                <h5 class="mb-2">${product.title}</h5>
                <p class="text-muted small mb-3">${product.description}</p>
                
                ${progress ? `
                  <div class="mb-3">
                    <div class="d-flex justify-content-between small text-muted mb-1">
                      <span>å­¸ç¿’é€²åº¦</span>
                      <span>${progress.completedUnits.length}/${progress.totalUnits} å–®å…ƒ</span>
                    </div>
                    <div class="product-progress">
                      <div class="product-progress-bar" style="width: ${progressPercent}%"></div>
                    </div>
                  </div>
                ` : ''}
                
                ${(product.tags || []).length > 0 ? `
                  <div class="product-tags">
                    ${product.tags.slice(0, 3).map(tag => `
                      <span class="product-tag">${tag}</span>
                    `).join('')}
                  </div>
                ` : ''}
                
                <div class="mt-auto pt-3">
                  ${purchased ? `
                    <button class="btn btn-success w-100" onclick="accessProduct('${product.id}', '${product.type}', '${product.contentUrl || product.downloadUrl}')">
                      <i class="fas fa-${product.type === 'tool' ? 'download' : 'play-circle'} me-2"></i>
                      ${product.type === 'tool' ? 'ä¸‹è¼‰' : product.type === 'course' ? 'ç¹¼çºŒå­¸ç¿’' : 'é–‹å§‹æŒ‘æˆ°'}
                    </button>
                  ` : `
                    <button class="btn btn-primary-shari w-100" onclick="purchaseProduct('${product.id}')">
                      <i class="fas fa-shopping-cart me-2"></i>
                      è³¼è²· - $${product.price}
                    </button>
                  `}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // è³¼è²·ç”¢å“
    window.purchaseProduct = async function(productId) {
      const user = auth.currentUser;
      if (!user || !user.email) {
        alert('è«‹å…ˆç™»å…¥');
        return;
      }

      try {
        const btn = event.target.closest('button');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> è™•ç†ä¸­...';

        const response = await fetch(`${WORKER_BASE}/api/checkout/create-product-session`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            productId,
            userEmail: user.email
          })
        });

        const data = await response.json();

        if (data.ok && data.checkoutUrl) {
          window.location.href = data.checkoutUrl;
        } else {
          throw new Error(data.error || 'å»ºç«‹ä»˜æ¬¾é é¢å¤±æ•—');
        }
      } catch (error) {
        console.error('âŒ è³¼è²·éŒ¯èª¤:', error);
        alert(error.message || 'è³¼è²·å¤±æ•—ï¼Œè«‹é‡è©¦');
        event.target.closest('button').disabled = false;
        event.target.closest('button').innerHTML = '<i class="fas fa-shopping-cart me-2"></i> è³¼è²·';
      }
    };

    // å­˜å–ç”¢å“
    window.accessProduct = function(productId, type, url) {
      if (type === 'course') {
        // å°å‘èª²ç¨‹é é¢ï¼ˆæœªä¾†å¯¦ä½œï¼‰
        window.location.href = `/lesson.html?course=${productId}`;
      } else if (type === 'challenge') {
        // å°å‘æŒ‘æˆ°é é¢ï¼ˆæœªä¾†å¯¦ä½œï¼‰
        window.location.href = `/challenge.html?id=${productId}`;
      } else if (url) {
        // ç›´æ¥ä¸‹è¼‰æˆ–é–‹å•Ÿé€£çµ
        window.open(url, '_blank');
      } else {
        alert('æ­¤ç”¢å“æš«ç„¡å…§å®¹é€£çµ');
      }
    };

    // ç¯©é¸æŒ‰éˆ•äº‹ä»¶
    document.getElementById('product-filter-buttons').addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') {
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('#product-filter-buttons button').forEach(btn => {
          btn.classList.remove('active');
        });
        e.target.classList.add('active');

        // æ›´æ–°ç¯©é¸æ¢ä»¶
        currentFilter = e.target.dataset.filter;
        renderProducts();
      }
    });

    // æœå°‹äº‹ä»¶
    document.getElementById('product-search').addEventListener('input', () => {
      renderProducts();
    });

    // åˆå§‹åŒ–ç”¢å“
    loadProducts();

    // ç•¶ä½¿ç”¨è€…ç™»å…¥å¾Œè¼‰å…¥å·²è³¼ç”¢å“
    onAuthStateChanged(auth, (user) => {
      if (user && user.email) {
        loadUserPurchases(user.email);
      }
    });
  </script>



<!--Start of Tawk.to Script-->
  <script type="text/javascript">
    var Tawk_API = Tawk_API || {},
      Tawk_LoadStart = new Date();
    (function () {
      var s1 = document.createElement("script"),
        s0 = document.getElementsByTagName("script")[0];
      s1.async = true;
      s1.src = 'https://embed.tawk.to/6838fcda70b16107011a0baa/1isf9ndi1';
      s1.charset = 'UTF-8';
      s1.setAttribute('crossorigin', '*');
      s0.parentNode.insertBefore(s1, s0);
    })();
  </script>
  <!--End of Tawk.to Script-->
  
</body>
</html>