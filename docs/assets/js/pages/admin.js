const WORKER_BASE="https://uxshari-workers.uxshari.workers.dev";let adminKey="",allProducts=[],editingProductId=null;async function loadProducts(){try{const e=await fetch(`${WORKER_BASE}/api/products`),t=await e.json();t.ok&&(allProducts=t.products,renderProducts())}catch(e){console.error("è¼‰å…¥ç”¢å“å¤±æ•—:",e),document.getElementById("products-list").innerHTML=`\n      <div class="alert alert-danger">\n        è¼‰å…¥å¤±æ•—ï¼š${e.message}\n      </div>\n    `}}function renderProducts(){const e=document.getElementById("search-products")?.value?.toLowerCase()||"",t=allProducts.filter(t=>t.title.toLowerCase().includes(e)||t.description.toLowerCase().includes(e)||t.type.includes(e)),n=document.getElementById("products-count");n&&(n.textContent=t.length);const d=document.getElementById("products-list");d&&(0!==t.length?d.innerHTML=t.map(e=>`\n    <div class="product-list-item">\n      <div class="row align-items-center">\n        <div class="col-auto">\n          <img src="${e.coverImage||"/assets/images/placeholder.jpg"}" \n               class="product-thumbnail" alt="${e.title}">\n        </div>\n        <div class="col">\n          <div class="d-flex align-items-center mb-1">\n            <span class="badge bg-primary me-2">${e.type}</span>\n            <span class="status-indicator ${e.isActive?"active":"inactive"}"></span>\n            <span class="small text-muted">${e.isActive?"ä¸Šæ¶ä¸­":"å·²ä¸‹æ¶"}</span>\n            ${e.isFeatured?'<span class="badge bg-warning ms-2">ç²¾é¸</span>':""}\n          </div>\n          <h5 class="mb-1">${e.title}</h5>\n          <p class="text-muted small mb-2">${e.description}</p>\n          <div class="small text-muted">\n            <span class="me-3">ğŸ’° $${e.price}</span>\n            <span class="me-3">ğŸ“¦ ${e.category||"N/A"}</span>\n            <span>ğŸ†” ${e.id}</span>\n          </div>\n        </div>\n        <div class="col-auto">\n          <button class="btn btn-sm btn-outline-primary me-2" onclick="editProduct('${e.id}')">\n            <i class="fas fa-edit"></i> ç·¨è¼¯\n          </button>\n          <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${e.id}', '${e.title}')">\n            <i class="fas fa-trash"></i> åˆªé™¤\n          </button>\n        </div>\n      </div>\n    </div>\n  `).join(""):d.innerHTML='\n      <div class="text-center py-5 text-muted">\n        <i class="fas fa-box-open fa-3x mb-3"></i>\n        <p>æ²’æœ‰ç”¢å“</p>\n      </div>\n    ')}function cancelEdit(){editingProductId=null;const e=document.getElementById("form-title"),t=document.getElementById("submit-btn-text");e&&(e.textContent="æ–°å¢ç”¢å“"),t&&(t.textContent="å»ºç«‹ç”¢å“"),document.getElementById("product-form")?.reset()}document.getElementById("verify-btn")?.addEventListener("click",async()=>{const e=document.getElementById("admin-key-input").value.trim();if(e)try{(await fetch(`${WORKER_BASE}/api/products?admin_key=${encodeURIComponent(e)}`)).ok?(adminKey=e,document.getElementById("auth-section").classList.add("d-none"),document.getElementById("admin-area").classList.remove("d-none"),loadProducts()):alert("ç®¡ç†å“¡å¯†é‘°éŒ¯èª¤")}catch(e){alert("é©—è­‰å¤±æ•—ï¼š"+e.message)}else alert("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†é‘°")}),document.getElementById("search-products")?.addEventListener("input",renderProducts),document.getElementById("product-form")?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("stripe-price-id").value.trim();if(!t.startsWith("price_"))return alert("âŒ Stripe Price ID æ ¼å¼éŒ¯èª¤ï¼\n\nå¿…é ˆå¾ Stripe Dashboard è¤‡è£½çœŸå¯¦çš„ Price ID\næ­£ç¢ºæ ¼å¼ï¼šprice_1QKm8xHNWqZ9vYjJ\n\nè«‹å…ˆåœ¨ Stripe å»ºç«‹ç”¢å“ï¼Œå†è¤‡è£½ Price ID éä¾†ã€‚"),void document.getElementById("stripe-price-id").focus();if(t.length<20)return alert("âŒ Price ID å¤ªçŸ­ï¼\n\né€™ä¸åƒæ˜¯çœŸå¯¦çš„ Stripe Price IDã€‚\nè«‹ç¢ºèªå·²å¾ Stripe Dashboard è¤‡è£½å®Œæ•´çš„ IDã€‚"),void document.getElementById("stripe-price-id").focus();const n={type:document.getElementById("product-type").value,title:document.getElementById("product-title").value,description:document.getElementById("product-description").value,price:parseFloat(document.getElementById("product-price").value),category:document.getElementById("product-category").value,level:document.getElementById("product-level").value,stripeProductId:document.getElementById("stripe-product-id").value,stripePriceId:document.getElementById("stripe-price-id").value,coverImage:document.getElementById("cover-image").value,downloadUrl:document.getElementById("download-url").value,contentUrl:document.getElementById("content-url").value,tags:document.getElementById("product-tags").value.split(",").map(e=>e.trim()).filter(e=>e),totalUnits:parseInt(document.getElementById("total-units").value)||0,freeUnits:parseInt(document.getElementById("free-units").value)||0,creditsReward:parseInt(document.getElementById("credits-reward").value)||0,isActive:document.getElementById("is-active").checked,isFeatured:document.getElementById("is-featured").checked,previewAvailable:document.getElementById("preview-available").checked};try{const e=editingProductId?`${WORKER_BASE}/api/products/${editingProductId}?admin_key=${encodeURIComponent(adminKey)}`:`${WORKER_BASE}/api/products?admin_key=${encodeURIComponent(adminKey)}`,t=editingProductId?"PATCH":"POST",d=await fetch(e,{method:t,headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),c=await d.json();c.ok?(alert(editingProductId?"ç”¢å“å·²æ›´æ–°ï¼":"ç”¢å“å·²å»ºç«‹ï¼"),cancelEdit(),loadProducts()):alert("æ“ä½œå¤±æ•—ï¼š"+c.error)}catch(e){alert("éŒ¯èª¤ï¼š"+e.message)}}),window.editProduct=function(e){const t=allProducts.find(t=>t.id===e);if(!t)return;editingProductId=e;const n=document.getElementById("form-title"),d=document.getElementById("submit-btn-text");n&&(n.textContent="ç·¨è¼¯ç”¢å“"),d&&(d.textContent="æ›´æ–°ç”¢å“"),document.getElementById("product-type").value=t.type,document.getElementById("product-title").value=t.title,document.getElementById("product-description").value=t.description,document.getElementById("product-price").value=t.price,document.getElementById("product-category").value=t.category||"",document.getElementById("product-level").value=t.level||"beginner",document.getElementById("stripe-product-id").value=t.stripeProductId||"",document.getElementById("stripe-price-id").value=t.stripePriceId||"",document.getElementById("cover-image").value=t.coverImage||"",document.getElementById("download-url").value=t.downloadUrl||"",document.getElementById("content-url").value=t.contentUrl||"",document.getElementById("product-tags").value=(t.tags||[]).join(", "),document.getElementById("total-units").value=t.totalUnits||0,document.getElementById("free-units").value=t.freeUnits||0,document.getElementById("credits-reward").value=t.creditsReward||0,document.getElementById("is-active").checked=t.isActive??!0,document.getElementById("is-featured").checked=t.isFeatured??!1,document.getElementById("preview-available").checked=t.previewAvailable??!1,window.scrollTo({top:0,behavior:"smooth"})},window.deleteProduct=async function(e,t){if(confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${t}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`))try{const t=await fetch(`${WORKER_BASE}/api/products/${e}?admin_key=${encodeURIComponent(adminKey)}`,{method:"DELETE"}),n=await t.json();n.ok?(alert("ç”¢å“å·²åˆªé™¤ï¼"),loadProducts()):alert("åˆªé™¤å¤±æ•—ï¼š"+n.error)}catch(e){alert("éŒ¯èª¤ï¼š"+e.message)}},document.getElementById("cancel-btn")?.addEventListener("click",cancelEdit);