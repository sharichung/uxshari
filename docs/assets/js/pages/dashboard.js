import{initializeApp,getApps,getApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getAuth,onAuthStateChanged,signOut}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import{getFirestore,doc,getDoc,onSnapshot}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";const firebaseConfig={apiKey:"AIzaSyCZs2a35ENke7G8K7pzAMKCY3HOoi-IUcU",authDomain:"uxshari-670fd.firebaseapp.com",projectId:"uxshari-670fd",appId:"1:907540538791:web:ed98ef4ba51c96de43c282"};getApps().length||initializeApp(firebaseConfig);const auth=getAuth(),db=getFirestore(),encEmail=e=>btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,""),hideLoading=()=>{const e=document.getElementById("loading-overlay");e&&e.style&&(e.style.display="none")},showLoading=()=>{const e=document.getElementById("loading-overlay");e&&e.style&&(e.style.display="flex")};function toDate(e){try{if(!e)return null;if(e instanceof Date)return isNaN(e.getTime())?null:e;const t=typeof e;if("number"===t){const t=new Date(e<1e12?1e3*e:e);return isNaN(t.getTime())?null:t}if("string"===t){const t=e.trim();if(/^\d+$/.test(t)){return toDate(Number(t))}const n=new Date(t);return isNaN(n.getTime())?null:n}if("object"===t){if("number"==typeof e.seconds){const t=1e3*e.seconds+Math.floor((e.nanoseconds||0)/1e6),n=new Date(t);return isNaN(n.getTime())?null:n}if("number"==typeof e._seconds){const t=1e3*e._seconds+Math.floor((e._nanoseconds||0)/1e6),n=new Date(t);return isNaN(n.getTime())?null:n}if("function"==typeof e.toDate)try{const t=e.toDate();return isNaN(t?.getTime?.())?null:t}catch{}}}catch(e){}return null}let elements={},dataReady=!1;function updateUI(e){if(console.log("ğŸ“Š [DASHBOARD] updateUI è¢«å‘¼å«ï¼Œå®Œæ•´è³‡æ–™ï¼š",e),dataReady=!0,!elements.creditsCount)return console.log("âš ï¸ [DASHBOARD] ç­‰å¾… DOM è¼‰å…¥..."),void setTimeout(()=>updateUI(e),100);const t=e?.credits??0,n=e?.isPaid??!1;console.log("ğŸ“… [DASHBOARD] è§£æçµæœ - credits:",t);try{localStorage.setItem("userPaid",n?"1":"0"),sessionStorage.setItem("userPaid",n?"1":"0")}catch(e){}elements.creditsCount.innerHTML=t,elements.creditsCard.classList.add("credits-updated"),setTimeout(()=>elements.creditsCard.classList.remove("credits-updated"),500),elements.statusBadge.innerHTML=n?'\n      <span class="badge-vip">\n        <i class="fas fa-crown"></i>\n        VIPæœƒå“¡\n      </span>\n    ':'\n      <span class="badge-normal">\n        <i class="fas fa-user"></i>\n        æ™®é€šæœƒå“¡\n      </span>\n    ',t>0?(elements.bookBtn.disabled=!1,elements.bookBtn.className="btn btn-lg btn-primary-shari w-100 w-md-auto",elements.bookBtn.innerHTML='<i class="fas fa-calendar-check me-2"></i> ç«‹å³é ç´„ 50 åˆ†é˜è¼”å°',elements.bookBtn.onclick=async()=>{try{elements.bookBtn.disabled=!0,elements.bookBtn.innerHTML='<i class="fas fa-spinner fa-spin me-2"></i> æº–å‚™é ç´„é€£çµ...';const e="https://uxshari-workers.uxshari.workers.dev",t=await fetch(`${e}/api/create-scheduling-link?email=${encodeURIComponent(auth.currentUser.email)}`),n=await t.json();if(!n.ok)throw new Error(n.error||"å»ºç«‹é ç´„é€£çµå¤±æ•—");window.open(n.url,"_blank")}catch(e){alert(e.message||"ç„¡æ³•å»ºç«‹é ç´„é€£çµï¼Œè«‹ç¨å¾Œå†è©¦")}finally{elements.bookBtn.disabled=!1,elements.bookBtn.innerHTML='<i class="fas fa-calendar-check me-2"></i> ç«‹å³é ç´„ 50 åˆ†é˜è¼”å°'}},elements.noCreditsAlert.classList.add("d-none"),elements.hasCreditsAlert.classList.remove("d-none")):(elements.bookBtn.disabled=!0,elements.bookBtn.className="btn btn-lg btn-primary-shari w-100 w-md-auto",elements.bookBtn.innerHTML='<i class="fas fa-lock me-2"></i> éœ€å…ˆè³¼è²·é ç´„é¡åº¦',elements.noCreditsAlert.classList.remove("d-none"),elements.hasCreditsAlert.classList.add("d-none"))}document.addEventListener("DOMContentLoaded",()=>{elements={userName:document.getElementById("user-name"),statusBadge:document.getElementById("status-badge-container"),creditsCount:document.getElementById("credits-count"),creditsCard:document.getElementById("credits-card"),bookBtn:document.getElementById("book-session-btn"),buyLink:document.getElementById("buy-link"),noCreditsAlert:document.getElementById("no-credits-alert"),hasCreditsAlert:document.getElementById("has-credits-alert"),logoutBtn:document.getElementById("logout-btn")},elements.logoutBtn&&elements.logoutBtn.addEventListener("click",async()=>{if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ"))try{await signOut(auth),window.location.href="/index.html"}catch(e){console.error("ç™»å‡ºéŒ¯èª¤:",e),alert("ç™»å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦")}}),setTimeout(()=>{try{dataReady||(console.warn("â³ [DASHBOARD] æ›è¼‰ 5s æœªå–å¾—è³‡æ–™ï¼Œä½¿ç”¨é è¨­å€¼æ¸²æŸ“"),updateUI({}))}catch(e){console.error(e)}},5e3)}),onAuthStateChanged(auth,async e=>{if(!e)return hideLoading(),void(window.location.href="/index.html");try{if(e.photoURL){try{localStorage.setItem("userAvatar",e.photoURL),sessionStorage.setItem("userAvatar",e.photoURL)}catch(e){}const t=document.getElementById("userAvatar");if(t&&"IMG"===t.tagName)t.src=e.photoURL;else{const t=document.querySelector('#mainNavbar a[href="account.html"]')||document.querySelector('a[href="account.html"]');if(t){const n=document.createElement("img");n.id="userAvatar",n.alt="User Avatar",n.className="rounded-circle",n.style.width="32px",n.style.height="32px",n.style.objectFit="cover",n.src=e.photoURL,t.innerHTML="",t.appendChild(n)}}}}catch(e){}if(elements.userName.textContent=e.displayName||e.email?.split("@")[0]||"æœƒå“¡",e.email){const t="https://uxshari-workers.uxshari.workers.dev";elements.buyLink.href=`${t}/api/checkout-redirect?email=${encodeURIComponent(e.email)}&origin=${encodeURIComponent(location.origin)}`,elements.buyLink.target="_self"}if(e.email){const t=doc(db,"users_by_email",encEmail(e.email));console.log("ğŸ” [DASHBOARD] é–‹å§‹ç›£è½ Firestoreï¼š",`users_by_email/${encEmail(e.email)}`),onSnapshot(t,e=>{if(hideLoading(),console.log("ğŸ“© [DASHBOARD] Firestore snapshot æ”¶åˆ°ï¼Œexists:",e.exists()),e.exists()){const t=e.data();console.log("âœ… [DASHBOARD] Firestore å®Œæ•´è³‡æ–™ï¼š",t),updateUI(t)}else console.warn("âš ï¸ [DASHBOARD] Firestore æ–‡æª”ä¸å­˜åœ¨"),updateUI({})},e=>{console.error("âŒ [DASHBOARD] Firestore ç›£è½éŒ¯èª¤:",e),hideLoading(),alert("ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹é‡æ–°æ•´ç†é é¢")})}else hideLoading()});const WORKER_BASE="https://uxshari-workers.uxshari.workers.dev";let allProducts=[],userPurchasedProducts=[],currentFilter="all";const productTypeConfig={tool:{icon:"ğŸ§°",name:"å·¥å…·",class:"product-type-tool"},course:{icon:"ğŸ“š",name:"èª²ç¨‹",class:"product-type-course"},challenge:{icon:"ğŸ¯",name:"æŒ‘æˆ°",class:"product-type-challenge"},resource:{icon:"ğŸ“¦",name:"è³‡æº",class:"product-type-resource"}};async function loadProducts(){try{const e=await fetch(`${WORKER_BASE}/api/products?active=true`),t=await e.json();if(!t.ok)throw new Error(t.error||"è¼‰å…¥ç”¢å“å¤±æ•—");allProducts=t.products,renderProducts()}catch(e){console.error("âŒ è¼‰å…¥ç”¢å“éŒ¯èª¤:",e),document.getElementById("products-loading").innerHTML='\n      <div class="text-center text-danger">\n        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>\n        <p>è¼‰å…¥ç”¢å“å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p>\n      </div>\n    '}}async function loadUserPurchases(e){try{const t=await fetch(`${WORKER_BASE}/api/user/purchased-products?email=${encodeURIComponent(e)}`),n=await t.json();n.ok&&(userPurchasedProducts=n.purchasedProducts||[],allProducts.length>0&&renderProducts())}catch(e){console.error("âŒ è¼‰å…¥è³¼è²·ç´€éŒ„éŒ¯èª¤:",e)}}function isPurchased(e){return userPurchasedProducts.some(t=>t.productId===e)}function getProductProgress(e){const t=userPurchasedProducts.find(t=>t.productId===e);return t?.progress||null}function renderProducts(){const e=document.getElementById("products-grid"),t=document.getElementById("products-loading"),n=document.getElementById("products-empty"),s=document.getElementById("product-search");if(!(e&&t&&n&&s))return void console.error("âŒ Required DOM elements not found");const o=s.value.toLowerCase();let a=allProducts.filter(e=>{let t=!0;"purchased"===currentFilter?t=isPurchased(e.id):"all"!==currentFilter&&(t=e.type===currentFilter);const n=!o||e.title.toLowerCase().includes(o)||e.description.toLowerCase().includes(o)||(e.tags||[]).some(e=>e.toLowerCase().includes(o));return t&&n});if(t.classList.add("d-none"),0===a.length)return n.classList.remove("d-none"),void(e.innerHTML="");n.classList.add("d-none"),e.innerHTML=a.map(e=>{const t=productTypeConfig[e.type]||productTypeConfig.tool,n=isPurchased(e.id),s=getProductProgress(e.id),o=s?Math.round(s.completedUnits.length/s.totalUnits*100):0;return`\n      <div class="col-md-6 col-lg-4">\n        <div class="product-card" data-product-id="${e.id}">\n          <div class="position-relative product-card-image-wrapper">\n            <img src="${e.coverImage||"https://images.unsplash.com/photo-1558655146-364adaf1fcc9?w=1200&h=800&fit=crop"}" \n                 class="product-card-image" \n                 alt="${e.title}"\n                 loading="lazy"\n                 onerror="this.src='https://images.unsplash.com/photo-1558655146-364adaf1fcc9?w=1200&h=800&fit=crop'">\n            <span class="product-badge ${n?"unlocked":"locked"}">\n              <i class="fas ${n?"fa-check-circle":"fa-lock"} me-1"></i>\n              ${n?"å·²è§£é–":"$"+e.price}\n            </span>\n          </div>\n          \n          <div class="p-3 flex-grow-1 d-flex flex-column">\n            <div class="${t.class} product-type-icon">\n              ${t.icon}\n            </div>\n            \n            <h5 class="mb-2">${e.title}</h5>\n            <p class="text-muted small mb-3">${e.description}</p>\n            \n            ${s?`\n              <div class="mb-3">\n                <div class="d-flex justify-content-between small text-muted mb-1">\n                  <span>å­¸ç¿’é€²åº¦</span>\n                  <span>${s.completedUnits.length}/${s.totalUnits} å–®å…ƒ</span>\n                </div>\n                <div class="product-progress">\n                  <div class="product-progress-bar" style="width: ${o}%"></div>\n                </div>\n              </div>\n            `:""}\n            \n            ${(e.tags||[]).length>0?`\n              <div class="product-tags">\n                ${e.tags.slice(0,3).map(e=>`\n                  <span class="product-tag">${e}</span>\n                `).join("")}\n              </div>\n            `:""}\n            \n            <div class="mt-auto pt-3">\n              ${n?`\n                <button class="btn btn-success w-100" onclick="window.dashboardAccessProduct('${e.id}', '${e.type}', '${e.contentUrl||e.downloadUrl}')">\n                  <i class="fas fa-${"tool"===e.type?"download":"play-circle"} me-2"></i>\n                  ${"tool"===e.type?"ä¸‹è¼‰":"course"===e.type?"ç¹¼çºŒå­¸ç¿’":"é–‹å§‹æŒ‘æˆ°"}\n                </button>\n              `:`\n                <button class="btn btn-primary-shari w-100" onclick="window.dashboardPurchaseProduct('${e.id}')">\n                  <i class="fas fa-shopping-cart me-2"></i>\n                  è³¼è²· - $${e.price}\n                </button>\n              `}\n            </div>\n          </div>\n        </div>\n      </div>\n    `}).join("")}window.dashboardPurchaseProduct=async function(e){const t=auth.currentUser;if(t&&t.email)try{const n=event.target.closest("button");n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin me-2"></i> è™•ç†ä¸­...';const s=await fetch(`${WORKER_BASE}/api/checkout/create-product-session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({productId:e,userEmail:t.email})}),o=await s.json();if(!o.ok||!o.checkoutUrl)throw new Error(o.error||"å»ºç«‹ä»˜æ¬¾é é¢å¤±æ•—");window.location.href=o.checkoutUrl}catch(e){console.error("âŒ è³¼è²·éŒ¯èª¤:",e),alert(e.message||"è³¼è²·å¤±æ•—ï¼Œè«‹é‡è©¦"),event.target.closest("button").disabled=!1,event.target.closest("button").innerHTML='<i class="fas fa-shopping-cart me-2"></i> è³¼è²·'}else alert("è«‹å…ˆç™»å…¥")},window.dashboardAccessProduct=function(e,t,n){"course"===t?window.location.href=`/lesson.html?course=${e}`:"challenge"===t?window.location.href=`/challenge.html?id=${e}`:n?window.open(n,"_blank"):alert("æ­¤ç”¢å“æš«ç„¡å…§å®¹é€£çµ")},document.getElementById("product-filter-buttons")?.addEventListener("click",e=>{"BUTTON"===e.target.tagName&&(document.querySelectorAll("#product-filter-buttons button").forEach(e=>{e.classList.remove("active")}),e.target.classList.add("active"),currentFilter=e.target.dataset.filter,renderProducts())}),document.getElementById("product-search")?.addEventListener("input",()=>{renderProducts()}),loadProducts(),onAuthStateChanged(auth,e=>{e&&e.email&&loadUserPurchases(e.email)});