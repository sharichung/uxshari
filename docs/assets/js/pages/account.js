import{initializeApp,getApps,getApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getAuth,onAuthStateChanged,updateProfile,signOut,sendPasswordResetEmail,reload,GoogleAuthProvider,signInWithEmailAndPassword,createUserWithEmailAndPassword,signInWithPopup,EmailAuthProvider,reauthenticateWithCredential,deleteUser}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import{getFirestore,setDoc,doc,serverTimestamp,deleteDoc,onSnapshot}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import{getStorage,ref as sRef,uploadBytes,getDownloadURL,listAll,deleteObject}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";const firebaseConfig={apiKey:"AIzaSyCZs2a35ENke7G8K7pzAMKCY3HOoi-IUcU",authDomain:"uxshari-670fd.firebaseapp.com",projectId:"uxshari-670fd",storageBucket:"uxshari-670fd.firebasestorage.app",appId:"1:907540538791:web:ed98ef4ba51c96de43c282"},app=getApps().length?getApp():initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app),storage=getStorage(app),encEmail=e=>btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"");function toDate(e){try{if(!e)return null;if(e instanceof Date)return isNaN(e.getTime())?null:e;const t=typeof e;if("number"===t){const t=new Date(e<1e12?1e3*e:e);return isNaN(t.getTime())?null:t}if("string"===t){const t=e.trim();if(/^\d+$/.test(t)){return toDate(Number(t))}const a=new Date(t);return isNaN(a.getTime())?null:a}if("object"===t){if("number"==typeof e.seconds){const t=1e3*e.seconds+Math.floor((e.nanoseconds||0)/1e6),a=new Date(t);return isNaN(a.getTime())?null:a}if("number"==typeof e._seconds){const t=1e3*e._seconds+Math.floor((e._nanoseconds||0)/1e6),a=new Date(t);return isNaN(a.getTime())?null:a}if("function"==typeof e.toDate)try{const t=e.toDate();return isNaN(t?.getTime?.())?null:t}catch{}}}catch(e){}return null}function formatTW(e){const t=toDate(e);if(!t)return"æ—¥æœŸæœªçŸ¥";try{return t.toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch{return t.toISOString()}}function formatAmount(e){const t=(e?.currency||"USD").toUpperCase();let a=null;"number"==typeof e?.amount?a=e.amount:"number"==typeof e?.amount_total?a=e.amount_total/100:"number"==typeof e?.amount_usd?a=e.amount_usd:"number"==typeof e?.unit_amount?a=e.unit_amount/100:"number"==typeof e?.amount_cents?a=e.amount_cents/100:"number"==typeof e?.price&&(a=e.price);return{currency:t,amountStr:null==a||Number.isNaN(a)?"-":Number(a).toFixed(2)}}const profileSection=document.getElementById("profile-section"),authSection=document.getElementById("auth-section"),avatarSection=document.getElementById("avatar-section"),settingsSection=document.getElementById("settings-section"),membershipSection=document.getElementById("membership-section"),paymentsSection=document.getElementById("payments-section"),emailEl=document.getElementById("userEmail"),displayNameEl=document.getElementById("userDisplayName"),saveBtn=document.getElementById("saveProfileBtn"),logoutBtn=document.getElementById("logoutBtn"),refreshBtn=document.getElementById("refresh-profile"),triggerResetBtn=document.getElementById("trigger-reset"),deleteAccountBtn=document.getElementById("delete-account-btn"),avatarPreview=document.getElementById("avatar-preview"),avatarFile=document.getElementById("avatar-file"),avatarUploadBtn=document.getElementById("avatar-upload-btn"),avatarCropOpen=document.getElementById("avatar-crop-open"),toast=document.createElement("div");function showSavedToast(){toast.classList.add("show"),setTimeout(()=>toast.classList.remove("show"),1800)}toast.className="save-toast",toast.innerHTML='<span class="icon"><i class="fas fa-check"></i></span><span>å·²å„²å­˜</span>',document.body.appendChild(toast);const emailInput=document.getElementById("email"),passwordInput=document.getElementById("password"),displayNameInput=document.getElementById("userDisplayName");function updateNavbarAvatar(e){try{if(!e)return;try{localStorage.setItem("userAvatar",e),sessionStorage.setItem("userAvatar",e)}catch(e){}let t=document.getElementById("userAvatar");if(t&&"IMG"===t.tagName)t.src=e;else{const t=document.querySelector('#mainNavbar a[href="account.html"]')||document.querySelector('a[href="account.html"]');if(t){const a=document.createElement("img");a.id="userAvatar",a.alt="User Avatar",a.className="rounded-circle",a.style.width="32px",a.style.height="32px",a.style.objectFit="cover",a.src=e,t.innerHTML="",t.appendChild(a)}}}catch(e){}}emailInput?.addEventListener("blur",function(){const e=document.getElementById("email-hint");this.validity.typeMismatch||this.validity.valueMissing?e?.classList.add("show"):e?.classList.remove("show")}),passwordInput?.addEventListener("input",function(){const e=document.getElementById("password-hint");this.value.length>0&&this.value.length<6?e?.classList.add("show"):e?.classList.remove("show")}),displayNameInput?.addEventListener("input",function(){const e=document.getElementById("displayname-hint");this.value.length>0&&(this.value.length<2||this.value.length>50)?e?.classList.add("show"):e?.classList.remove("show")}),onAuthStateChanged(auth,async e=>{if(document.getElementById("loading-overlay").style.display="none",e){if(authSection.classList.add("d-none"),profileSection.classList.remove("d-none"),avatarSection.classList.remove("d-none"),settingsSection.classList.remove("d-none"),membershipSection.classList.remove("d-none"),paymentsSection.classList.remove("d-none"),emailEl.textContent=e.email||"",displayNameEl.value=e.displayName||"",e.photoURL&&(avatarPreview.src=e.photoURL,updateNavbarAvatar(e.photoURL)),e.email){const t=doc(db,"users_by_email",encEmail(e.email));onSnapshot(t,e=>{if(e.exists()){const t=e.data();console.log("ğŸ“Š [ACCOUNT] Firestore è³‡æ–™æ›´æ–°:",t);const a=document.getElementById("membership-badge-container"),s=document.getElementById("membership-status"),n=document.getElementById("member-since");if(t.isPaid?(a&&(a.innerHTML='<span class="badge-vip"><i class="fas fa-crown me-2"></i>VIPæœƒå“¡</span>'),s&&(s.textContent="VIPæœƒå“¡")):(a&&(a.innerHTML='<span class="badge-normal"><i class="fas fa-user me-2"></i>æ™®é€šæœƒå“¡</span>'),s&&(s.textContent="æ™®é€šæœƒå“¡")),t.createdAt){const e=toDate(t.createdAt);e&&(n.textContent=e.toLocaleDateString("zh-TW",{year:"numeric",month:"long",day:"numeric"}))}const o=t.payments||[],r=document.getElementById("payments-list");o.length>0?r.innerHTML=o.slice().reverse().map(e=>{const{currency:t,amountStr:a}=formatAmount(e);return`\n                <div class="d-flex justify-content-between align-items-center border-bottom py-3">\n                  <div>\n                    <div class="fw-bold">${t} $${a}</div>\n                    <div class="small text-muted">${formatTW(e.createdAt)}</div>\n                    ${e.receiptUrl?`<a class="small" href="${e.receiptUrl}" target="_blank">æŸ¥çœ‹æ”¶æ“š</a>`:""}\n                  </div>\n                  <span class="badge bg-success">å·²å®Œæˆ</span>\n                </div>\n              `}).join(""):r.innerHTML='<p class="text-muted mb-0">å°šç„¡ä»˜æ¬¾ç´€éŒ„</p>'}else console.warn("âš ï¸ [ACCOUNT] Firestore æ–‡æª”ä¸å­˜åœ¨")},e=>{console.error("âŒ [ACCOUNT] Firestore ç›£è½éŒ¯èª¤:",e)})}}else profileSection.classList.add("d-none"),avatarSection.classList.add("d-none"),settingsSection.classList.add("d-none"),membershipSection.classList.add("d-none"),paymentsSection.classList.add("d-none"),authSection.classList.remove("d-none")}),document.getElementById("auth-form")?.addEventListener("submit",async e=>{e.preventDefault();const t=emailInput?.value?.trim(),a=passwordInput?.value,s=document.getElementById("error");if(t&&a){s?.classList.add("d-none"),s&&(s.textContent="");try{await signInWithEmailAndPassword(auth,t,a)}catch(e){if("auth/user-not-found"===e?.code||"auth/invalid-credential"===e?.code)try{const e=await createUserWithEmailAndPassword(auth,t,a);await setDoc(doc(db,"users",e.user.uid),{email:t,role:"free",createdAt:serverTimestamp()},{merge:!0})}catch(e){s&&(s.textContent=e.message),s?.classList.remove("d-none")}else s&&(s.textContent=e.message),s?.classList.remove("d-none")}}}),document.getElementById("google-auth")?.addEventListener("click",async()=>{try{await signInWithPopup(auth,new GoogleAuthProvider)}catch(e){const t=document.getElementById("error");t&&(t.textContent=e.message),t?.classList.remove("d-none")}}),saveBtn?.addEventListener("click",async function(){const e=auth.currentUser;if(!e)return;const t=(displayNameEl.value||"").trim();try{const a=document.getElementById("profile-status");a&&(a.textContent="ä¿å­˜ä¸­â€¦",a.classList.remove("success","error")),await updateProfile(e,{displayName:t});try{await setDoc(doc(db,"users",e.uid),{displayName:t,email:e.email||null,updatedAt:serverTimestamp()},{merge:!0})}catch(e){console.warn("Firestore åŒæ­¥æš±ç¨±å¤±æ•—ï¼ˆå·²å¿½ç•¥ï¼‰:",e?.message||e)}showSavedToast(),a&&(a.textContent="å·²ä¿å­˜ï¼",a.classList.add("success"))}catch(e){const t=document.getElementById("profile-status");t&&(t.textContent="ä¿å­˜å¤±æ•—ï¼š"+(e?.message||e),t.classList.add("error")),alert("âŒ æ›´æ–°å¤±æ•—ï¼š"+e.message)}}),logoutBtn?.addEventListener("click",async function(){try{await signOut(auth),window.location.href="/index.html"}catch(e){alert("âŒ ç™»å‡ºéŒ¯èª¤ï¼š"+e.message)}}),refreshBtn?.addEventListener("click",async function(){try{await reload(auth.currentUser);const e=auth.currentUser;if(!e)return;displayNameEl.value=e.displayName||"",e.photoURL&&(avatarPreview.src=e.photoURL)}catch(e){alert("âŒ é‡æ–°è¼‰å…¥å¤±æ•—ï¼š"+e.message)}}),triggerResetBtn?.addEventListener("click",async function(){const e=auth.currentUser;if(!e?.email)return alert("è«‹å…ˆç™»å…¥");try{await sendPasswordResetEmail(auth,e.email),alert("å·²å¯„å‡ºå¯†ç¢¼é‡è¨­ä¿¡åˆ°ï¼š"+e.email)}catch(e){alert("âŒ å¯„é€å¤±æ•—ï¼š"+e.message)}}),window.openPasswordResetModal=()=>{const e=document.getElementById("password-reset-modal");if(!e)return;e.classList.add("active"),e.style.display="block",e.style.opacity="1",e.style.visibility="visible",document.body.style.overflow="hidden";const t=document.getElementById("reset-email"),a=auth.currentUser;a?.email&&t&&(t.value=a.email)};const closeReset=()=>{const e=document.getElementById("password-reset-modal");e&&(e.classList.remove("active"),e.style.opacity="0",e.style.visibility="hidden",setTimeout(()=>e.style.display="none",300),document.body.style.overflow="")};let cropper;function openCropperModal(e){const t=document.createElement("div");t.className="modal fade",t.tabIndex=-1,t.innerHTML=`\n    <div class="modal-dialog modal-dialog-centered modal-lg">\n      <div class="modal-content" data-clarity-mask="true">\n        <div class="modal-header">\n          <h5 class="modal-title"><i class="fas fa-crop me-2"></i>è£å‰ªé ­åƒ</h5>\n          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n        </div>\n        <div class="modal-body">\n          <div class="crop-container" data-clarity-mask="true"><img id="crop-image" src="${e}" alt="Crop"></div>\n        </div>\n        <div class="modal-footer">\n          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>\n          <button type="button" class="btn btn-primary-shari" id="confirm-crop">è£å‰ªä¸¦ä¿å­˜</button>\n        </div>\n      </div>\n    </div>`,document.body.appendChild(t);const a=new bootstrap.Modal(t);function s(e){cropper=new Cropper(e,{aspectRatio:1,viewMode:1,dragMode:"move",background:!0,autoCropArea:.9,responsive:!0,restore:!1,guides:!0,center:!0,highlight:!0,cropBoxMovable:!0,cropBoxResizable:!0,toggleDragModeOnDblclick:!1,minCropBoxWidth:100,minCropBoxHeight:100,ready:function(){console.log("âœ… Cropper initialized")}})}a.show(),t.addEventListener("shown.bs.modal",()=>{const e=t.querySelector("#crop-image");e.complete?s(e):e.addEventListener("load",()=>s(e))}),t.addEventListener("hidden.bs.modal",()=>{try{cropper?.destroy()}catch(e){}t.remove()});const n=t.querySelector("#confirm-crop"),o=t.querySelector('[data-bs-dismiss="modal"]');n?.addEventListener("click",async()=>{try{n.disabled=!0,o?.setAttribute("disabled","true"),n.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>ä¿å­˜ä¸­â€¦';const e=cropper.getCroppedCanvas({width:256,height:256,imageSmoothingQuality:"high"});let t=await new Promise(t=>e.toBlob(t,"image/webp",.85));if(t||(t=await new Promise(t=>e.toBlob(t,"image/jpeg",.85))),!t)throw new Error("è£å‰ªå¤±æ•—");const s=auth.currentUser;if(!s)throw new Error("è«‹å…ˆç™»å…¥");const r=Date.now(),i=sRef(storage,`avatars/${s.uid}_${r}.jpg`);await uploadBytes(i,t,{contentType:"image/jpeg",cacheControl:"public, max-age=31536000",customMetadata:{optimized:"true"}});const c=await getDownloadURL(i);await updateProfile(s,{photoURL:c});try{await setDoc(doc(db,"users",s.uid),{photoURL:c,updatedAt:serverTimestamp()},{merge:!0})}catch(e){console.warn("Firestore åŒæ­¥é ­åƒå¤±æ•—ï¼ˆå·²å¿½ç•¥ï¼‰:",e?.message||e)}try{const e=await listAll(sRef(storage,"avatars")),t=`${s.uid}_`,a=e.items.filter(e=>e.name.startsWith(t)&&e.fullPath!==i.fullPath);await Promise.allSettled(a.map(e=>deleteObject(e)))}catch(e){console.warn("æ¸…ç†èˆŠé ­åƒå¤±æ•—ï¼ˆå·²å¿½ç•¥ï¼‰:",e?.message||e)}avatarPreview.src=c,updateNavbarAvatar(c),n.blur(),a.hide(),showSavedToast();const d=document.getElementById("avatar-status");d&&(d.textContent="å·²ä¿å­˜ï¼",d.classList.remove("error"),d.classList.add("success"))}catch(e){const t=document.getElementById("avatar-status");t&&(t.textContent="ä¿å­˜å¤±æ•—ï¼š"+(e?.message||e),t.classList.remove("success"),t.classList.add("error")),alert("âŒ ä¸Šè¼‰å¤±æ•—ï¼š"+e.message)}finally{n&&(n.disabled=!1,n.innerHTML="è£å‰ªä¸¦ä¿å­˜"),o?.removeAttribute("disabled")}}),t.addEventListener("hidden.bs.modal",()=>{try{avatarUploadBtn?.focus()}catch(e){}})}document.getElementById("close-reset-modal")?.addEventListener("click",closeReset),document.getElementById("cancel-reset")?.addEventListener("click",closeReset),document.getElementById("submit-reset")?.addEventListener("click",async()=>{const e=document.getElementById("reset-email")?.value;if(!e)return alert("è«‹è¼¸å…¥é›»å­éƒµä»¶åœ°å€ï¼");try{await sendPasswordResetEmail(auth,e),alert("å¯†ç¢¼é‡è¨­é€£çµå·²ç™¼é€åˆ°æ‚¨çš„é›»å­éƒµä»¶ï¼"),closeReset()}catch(e){alert("ç™¼é€å¯†ç¢¼é‡è¨­é€£çµå¤±æ•—ï¼š"+e.message)}}),avatarUploadBtn?.addEventListener("click",()=>avatarFile.click()),avatarFile?.addEventListener("change",e=>{const t=e.target.files?.[0];if(!t)return;const a=new FileReader;a.onload=()=>openCropperModal(a.result),a.readAsDataURL(t)}),deleteAccountBtn?.addEventListener("click",function(){new bootstrap.Modal(document.getElementById("delete-reauth-modal")).show()}),document.getElementById("confirm-delete")?.addEventListener("click",async function(){const e=document.getElementById("reauth-password").value;if(!e)return alert("è«‹è¼¸å…¥å¯†ç¢¼");const t=auth.currentUser;if(!t?.email)return alert("è«‹å…ˆç™»å…¥");try{const a=EmailAuthProvider.credential(t.email,e);await reauthenticateWithCredential(t,a),await deleteDoc(doc(db,"users",t.uid)),await deleteUser(t),alert("å¸³è™Ÿå·²åˆªé™¤ï¼Œæ„Ÿè¬ä½¿ç”¨ UXShari"),window.location.href="/index.html"}catch(e){"auth/wrong-password"===e.code?alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦"):"auth/requires-recent-login"===e.code?alert("âŒ è«‹ç™»å‡ºå¾Œé‡æ–°ç™»å…¥ï¼Œå†åŸ·è¡Œåˆªé™¤"):alert("âŒ åˆªé™¤å¤±æ•—ï¼š"+e.message)}});