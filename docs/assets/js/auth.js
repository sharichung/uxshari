const __firebaseConfig={apiKey:"AIzaSyCZs2a35ENke7G8K7pzAMKCY3HOoi-IUcU",authDomain:"uxshari-670fd.firebaseapp.com",projectId:"uxshari-670fd",storageBucket:"uxshari-670fd.firebasestorage.app",appId:"1:907540538791:web:ed98ef4ba51c96de43c282"};function __ensureFirebaseApp(){try{return"undefined"!=typeof firebase&&(firebase.apps.length||firebase.initializeApp(__firebaseConfig),!0)}catch(e){return console.warn("Firebase 初始化失敗（已忽略）:",e?.message||e),!1}}__ensureFirebaseApp(),document.addEventListener("DOMContentLoaded",function(){if(!__ensureFirebaseApp())return;const e=firebase.auth(),t=firebase.firestore();try{firebase.auth().onAuthStateChanged(e=>{const t=window.location.pathname;["/index.html","/pricing.html"].includes(t)||(!["/dashboard.html","/account.html","/lesson.html"].includes(t)||e?!["/success.html"].includes(t)||e&&"paid"===e.role?e||(window.location.href="/index.html"):window.location.href="/payment.html":window.location.href="/index.html")})}catch(e){}function a(t,a){if("auth/email-already-in-use"===t.code||"auth/account-exists-with-different-credential"===t.code){a.innerText="這個 Email 已經有其他登入方式，請用 Google 登入。";const t=new firebase.auth.GoogleAuthProvider;e.signInWithPopup(t).then(()=>window.location.href="/dashboard.html").catch(e=>a.innerText="Google 登入失敗："+e.message)}else"auth/wrong-password"===t.code?a.innerText="密碼錯誤，請重新輸入。":"auth/invalid-email"===t.code?a.innerText="電子郵件格式錯誤。":a.innerText=t.message}function n(){const e=document.getElementById("password-reset-modal");e&&(e.classList.remove("active"),e.style.opacity="0",e.style.visibility="hidden",setTimeout(()=>e.style.display="none",300),document.body.style.overflow="")}document.getElementById("auth-form")?.addEventListener("submit",async function(n){n.preventDefault();const i=document.getElementById("email").value.trim(),o=document.getElementById("password").value,s=document.getElementById("error");s.innerText="";try{await e.signInWithEmailAndPassword(i,o),window.location.href="/dashboard.html"}catch(n){if("auth/user-not-found"===n.code||"auth/invalid-credential"===n.code)try{const a=await e.createUserWithEmailAndPassword(i,o);if(!a.user)return void(s.innerText="註冊失敗，請稍後再試。");await t.collection("users").doc(a.user.uid).set({email:i,role:"free",createdAt:firebase.firestore.FieldValue.serverTimestamp()}),window.location.href="/dashboard.html"}catch(e){a(e,s)}else a(n,s)}}),document.getElementById("google-auth")?.addEventListener("click",function(){const t=new firebase.auth.GoogleAuthProvider;e.signInWithPopup(t).then(async e=>{const t=e.user;if(!t.providerData.map(e=>e.providerId).includes("password")){const e=prompt("請設定一組密碼，之後可以用 Email/密碼登入：");if(e&&e.length>=6){const a=firebase.auth.EmailAuthProvider.credential(t.email,e);try{await t.linkWithCredential(a),alert("密碼設定成功，之後可以用 Email/密碼或 Google 登入！")}catch(e){alert("密碼連結失敗："+e.message)}}}window.location.href="/dashboard.html"}).catch(e=>document.getElementById("error").innerText=e.message)}),document.getElementById("submit-reset")?.addEventListener("click",async()=>{const e=document.getElementById("reset-email").value;document.getElementById("error");if(!e)return alert("請輸入電子郵件地址！");try{await firebase.auth().sendPasswordResetEmail(e),alert("密碼重設連結已發送到您的電子郵件！"),n()}catch(e){alert("發送密碼重設連結失敗："+e.message)}}),window.openPasswordResetModal=()=>{const e=document.getElementById("password-reset-modal");e?.classList.add("active"),e.style.display="block",e.style.opacity="1",e.style.visibility="visible",document.body.style.overflow="hidden"},document.getElementById("close-reset-modal")?.addEventListener("click",n),document.getElementById("cancel-reset")?.addEventListener("click",n)});