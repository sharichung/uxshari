<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UX ç—›é»è§€å¯Ÿæ¸…å–® | UXShari æœƒå“¡å·¥å…·</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="assets/css/general.css">
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&amp;family=Tektur:wght@400;500;600;700&amp;display=swap"
    rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
  <script src="assets/js/clarity.js" defer></script>
 
  
</head>
<body data-navbar-type="general">

  <!-- Loading -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="text-center">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
      </div>
      <p class="mt-3 text-muted">è¼‰å…¥æ‚¨çš„æ¸…å–®...</p>
    </div>
  </div>

  <!-- Navbar -->
  <div id="navbar"><nav id="mainNavbar"
    class="fade-in-down navbar-general navbar navbar-expand-lg position-fixed top-0 start-0 end-0 px-3 py-2 bg-white shadow-sm transition"
    style="z-index: 1030;">
    <div class="container">
      <!-- Logo -->
      <a href="dashboard.html" class="enter-fadein logo futuristic-hover navbar-brand d-flex align-items-center">
        <svg width="570" height="119" viewBox="0 0 570 119" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-labelledby="uxshari-logo-title" style="width:240px;height:auto;margin:8px 0;"></svg>
          <title id="uxshari-logo-title">UXShari æ¨™èªŒ</title>
          <g clip-path="url(#a)">
            <path d="M78.15 0c.22.16 2.4 4.5 2.11 4.9-24.13 9.75-42.1 34.7-24.01 59.01 4.7-10.74 14.88-18.65 26.01-21.99-4.49 10.14-10.81 17.16-6.47 28.97 6.19 16.81 29.73 11.03 42.45 6.52-11.11 15.18-30.3 29.07-50.2 23.23-10.07-2.96-12.51-9.93-16.28-18.69L5.61 117.76c-2.49 2.57-6.95.26-5.23-2.73.3-.52 8.01-4.95 9.89-6.6C29.62 91.39 29.78 74.9 18.78 52.9c-1.09-2.18-5.99-8.31-5.1-9.98z" fill="#fe8a02"/>
            <path d="M374.26 23.92v14h-38v14l39 3v30.5c0 .67-8.83 9.5-9.5 9.5h-43.5v-13h38v-16l-39-3v-28.5c0-.74 9.76-10.5 10.5-10.5zm-195 57h25v-55.5c0-2.56 12.56-1.17 15-1.5v60.5c0 .67-8.84 9.21-9.45 9.55-1.67.96-2.24.83-3.99 1.01-4.43.44-27.69.68-30.86-.27-.71-.21-10.7-9.55-10.7-10.3V23.92c2.44.33 15-1.06 15 1.5zm108-57c1.94 1.97-13.34 29.22-13.74 34.36l15.74 36.64h-15.5c-3.32-3.81-10.35-27.86-13.16-28.83-1.34-.46-5.34-.46-6.68 0-2.8.97-9.84 25.03-13.16 28.83h-15.5L241 58.28c-3.26-11.84-11.42-22.47-13.74-34.36h14.5c.62 0 1.95 2.84 2.37 3.63 3.23 5.92 5.74 17.97 9.21 22.79 1.43 1.99 4.16 2.12 6.25 1.43 3.1-1.03 10.78-27.84 13.16-27.84h14.5zm113 0v14h25.5c.81 0 11.5 10.69 11.5 11.5v45.5h-15v-44h-22v44h-15v-71zm97 71h-40.5c-.74 0-10.5-9.76-10.5-10.5v-22.5l36-1v-10h-34v-13h37.5c.81 0 11.5 10.69 11.5 11.5zm-36-12h21v-13c-3.07.41-19.89.94-20.89 2.11-.74.86.3 8.85-.11 10.89m86-45v14h-25v43h-15v-45.5c0-.81 10.69-11.5 11.5-11.5zm22 0h-15v57h15zm0-5h-15V21.91c11.27.35 16.98-3.57 15 11.01" fill="#060606"/>
          </g>
          <defs>
            <clipPath id="a">
              <path fill="#060606" d="M0 0h569.65v118.87H0z"/>
            </clipPath>
          </defs>
        </svg>
      </a>


      <a class="d-flex align-items-center text-dark text-decoration-none" href="account.html" role="button">
        <i class="fas fa-user-circle text-dark" role="img" aria-label="æœƒå“¡å¸³è™Ÿ"></i>
      </a>
    </div>
  </nav>

  <script>
    window.addEventListener('scroll', function () {
      const navbar = document.getElementById('mainNavbar');
      if (window.scrollY > 10) {
        navbar.classList.add('navbar-scrolled');
      } else {
        navbar.classList.remove('navbar-scrolled');
      }
    });
  </script>
</div>

  <!-- Hero Section -->
  <section class="hero-section no-print">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <h1 class="display-5 fw-bold mb-3">
            <i class="fas fa-clipboard-check me-3"></i>
            UX ç—›é»è§€å¯Ÿæ¸…å–®
          </h1>
          <p class="lead mb-0">
            å°ˆæ¡ˆåŒ–ç®¡ç†ã€æ™ºæ…§å»ºè­°ã€å³æ™‚åŒæ­¥ â€” è®“ UX ç ”ç©¶æ›´æœ‰æ¢ç†
          </p>
        </div>
        <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
          <div class="d-flex flex-column gap-2">
            <span class="badge bg-light text-dark fs-6">
              <i class="fas fa-crown me-2"></i>
              <span id="user-status">å…è²»æœƒå“¡</span>
            </span>
            <span class="badge bg-light text-dark fs-6">
              <i class="fas fa-list me-2"></i>
              æ¸…å–®ï¼š<strong id="checklist-count">0</strong> / <span id="checklist-limit">3</span>
            </span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="container pb-5">

    <!-- Limit Notice -->
    <div id="limit-notice" class="limit-notice d-none">
      <div class="d-flex align-items-center">
        <i class="fas fa-exclamation-triangle fa-2x text-warning me-3"></i>
        <div class="flex-grow-1">
          <h6 class="mb-1 fw-bold">å·²é”å…è²»æœƒå“¡æ¸…å–®ä¸Šé™ï¼ˆ3 å¼µï¼‰</h6>
          <p class="mb-0 small">å‡ç´šä»˜è²»æœƒå“¡ï¼šç„¡é™æ¸…å–® + AI å»ºè­° + PDF å ±å‘Š + åœ˜éšŠå”ä½œ</p>
        </div>
        <a href="/pricing.html" class="btn btn-warning btn-sm ms-3 flex-shrink-0">
          <i class="fas fa-crown me-2"></i>ç«‹å³å‡ç´š
        </a>
      </div>
    </div>

    <!-- Action Bar -->
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
      <h2 class="h4 mb-0">æˆ‘çš„æ¸…å–®</h2>
      <button id="create-checklist-btn" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>å»ºç«‹æ–°æ¸…å–®
      </button>
    </div>

    <!-- Checklists Container -->
    <div id="checklists-container">
      <!-- Empty State -->
      <div class="empty-state" id="empty-state">
        <div class="empty-icon">
          <i class="fas fa-clipboard-list"></i>
        </div>
        <h3 class="mb-3">é–‹å§‹æ‚¨çš„ç¬¬ä¸€å€‹ UX å°ˆæ¡ˆ</h3>
        <p class="text-muted mb-4">é¸æ“‡å°ˆæ¡ˆé¡å‹ï¼Œç³»çµ±å°‡è‡ªå‹•è¼‰å…¥å°ˆæ¥­çš„ç—›é»æª¢æŸ¥æ¨¡æ¿</p>
        <button class="btn btn-primary btn-lg" onclick="document.getElementById('create-checklist-btn').click()">
          <i class="fas fa-rocket me-2"></i>å»ºç«‹ç¬¬ä¸€å¼µæ¸…å–®
        </button>
        <div class="mt-4">
          <small class="text-muted">ğŸ’¡ æç¤ºï¼šæ¯å€‹æ¸…å–®éƒ½åŒ…å«æµç¨‹ã€ä»‹é¢ã€æƒ…å¢ƒä¸‰å¤§é¡ç—›é»æª¢æŸ¥</small>
        </div>
      </div>
    </div>

    <!-- Upgrade CTA -->
    <div class="upgrade-cta no-print">
      <i class="fas fa-graduation-cap fa-3x mb-3"></i>
      <h3 class="mb-3">æƒ³è¦æ›´æ·±å…¥çš„ UX ç—›é»æ‹†è§£æ–¹æ³•ï¼Ÿ</h3>
      <p class="mb-4 lead">å­¸ç¿’å¦‚ä½•ç³»çµ±åŒ–åˆ†æä½¿ç”¨è€…ç—›é»ã€å»ºç«‹åŒç†å¿ƒåœ°åœ–ã€è¨­è¨ˆè§£æ±ºæ–¹æ¡ˆ</p>
      <a href="/pricing.html" class="btn btn-light btn-lg me-3">
        <i class="fas fa-book-open me-2"></i>æŸ¥çœ‹å®Œæ•´èª²ç¨‹
      </a>
      <a href="/dashboard.html" class="btn btn-outline-light btn-lg">
        <i class="fas fa-th-large me-2"></i>è¿”å›å„€è¡¨æ¿
      </a>
    </div>

  </div>

  <!-- æˆå°±æç¤º Toast -->
  <div id="achievement-toast" class="achievement-toast">
    <div class="d-flex align-items-center">
      <i class="fas fa-trophy fa-2x text-warning me-3"></i>
      <div>
        <p class="mb-0 small" id="achievement-text">ä½ å·²ç¶“æŒæ¡ 80% çš„ UX ç—›é»è§€å¯ŸæŠ€å·§</p>
      </div>
    </div>
  </div>

  <!-- å„²å­˜æŒ‡ç¤ºå™¨ -->
  <div id="save-indicator" class="save-indicator">
    <i class="fas fa-check-circle"></i>
    <span>å·²è‡ªå‹•å„²å­˜</span>
  </div>

  <!-- å¾©åŸæç¤º -->
  <div id="undo-toast" class="undo-toast">
    <span id="undo-text">å·²åˆªé™¤</span>
    <button id="undo-btn" class="btn btn-light btn-sm">å¾©åŸ</button>
  </div>

  <!-- å°ˆæ¡ˆé¡å‹é¸æ“‡ Modal -->
  <div class="modal fade" id="projectTypeModal" tabindex="-1" aria-labelledby="projectTypeModalLabel">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header border-0">
          <h5 class="modal-title fw-bold" id="projectTypeModalLabel">é¸æ“‡å°ˆæ¡ˆé¡å‹</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-3">ç³»çµ±å°‡æ ¹æ“šå°ˆæ¡ˆé¡å‹è‡ªå‹•è¼‰å…¥å°æ‡‰çš„ç—›é»æª¢æŸ¥æ¨¡æ¿</p>
          <div class="project-type-grid" id="project-type-grid"></div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" id="confirm-project-type">
            <i class="fas fa-check me-2"></i>ç¢ºèªå»ºç«‹
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Fallback: hide loader if module fails to initialize (parse/runtime error)
    (function(){
      const safety = setTimeout(() => {
        const el = document.getElementById('loading-overlay');
        if (el) el.style.display = 'none';
      }, 8000);
      window.__uxChecklistOk = () => clearTimeout(safety);
      window.addEventListener('error', function(){
        const el = document.getElementById('loading-overlay');
        if (el) el.style.display = 'none';
      }, true);
    })();
  </script>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCZs2a35ENke7G8K7pzAMKCY3HOoi-IUcU",
      authDomain: "uxshari-670fd.firebaseapp.com",
      projectId: "uxshari-670fd",
      appId: "1:907540538791:web:ed98ef4ba51c96de43c282"
    };

    if (!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    const encEmail = (e) => btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");

    // å°ˆæ¡ˆé¡å‹èˆ‡æ¨¡æ¿å®šç¾©
    const projectTypes = [
      {
        id: 'ecommerce',
        name: 'é›»å•†å¹³å°',
        icon: 'ğŸ›’',
        desc: 'è³¼ç‰©ã€çµå¸³ã€ç‰©æµ',
        template: {
          process: [
            { id: 'e_p1', text: 'å•†å“æœå°‹åŠŸèƒ½æ˜¯å¦ç›´è¦ºï¼Ÿèƒ½å¦å¿«é€Ÿæ‰¾åˆ°ç›®æ¨™å•†å“ï¼Ÿ', checked: false, suggestion: 'å»ºè­°ï¼šåŠ å…¥æ™ºèƒ½æ¨è–¦ã€ç¯©é¸æ¢ä»¶' },
            { id: 'e_p2', text: 'åŠ å…¥è³¼ç‰©è»Šæµç¨‹æ˜¯å¦é †æš¢ï¼Ÿ', checked: false, suggestion: 'åƒè€ƒï¼šä¸€éµåŠ è³¼ã€æ‰¹é‡é¸è³¼' },
            { id: 'e_p3', text: 'çµå¸³æ­¥é©Ÿæ˜¯å¦éæ–¼è¤‡é›œï¼Ÿéœ€è¦å¤šå°‘æ­¥é©Ÿå®Œæˆï¼Ÿ', checked: false, suggestion: 'å„ªåŒ–ï¼šæ¸›å°‘è¡¨å–®æ¬„ä½ã€æ”¯æ´å¿«é€Ÿçµå¸³' },
            { id: 'e_p4', text: 'ä»˜æ¬¾æ–¹å¼æ˜¯å¦å¤šå…ƒï¼Ÿï¼ˆä¿¡ç”¨å¡ã€è½‰å¸³ã€ç¬¬ä¸‰æ–¹æ”¯ä»˜ï¼‰', checked: false, suggestion: 'æä¾›ï¼šå¤šç¨®æ”¯ä»˜é¸é …æå‡è½‰æ›ç‡' },
            { id: 'e_p5', text: 'è¨‚å–®è¿½è¹¤èˆ‡é€€è²¨æµç¨‹æ˜¯å¦æ¸…æ™°ï¼Ÿ', checked: false, suggestion: 'å¿…å‚™ï¼šå³æ™‚ç‰©æµè¿½è¹¤ã€ç°¡æ˜“é€€è²¨æ”¿ç­–' }
          ],
          interface: [
            { id: 'e_i1', text: 'å•†å“åœ–ç‰‡æ˜¯å¦æ¸…æ™°ï¼Ÿæ”¯æ´å¤šè§’åº¦æª¢è¦–ï¼Ÿ', checked: false, suggestion: 'å»ºè­°ï¼š360åº¦æª¢è¦–ã€æ”¾å¤§åŠŸèƒ½' },
            { id: 'e_i2', text: 'å•†å“æè¿°æ˜¯å¦å®Œæ•´ï¼Ÿï¼ˆè¦æ ¼ã€å°ºå¯¸ã€æè³ªï¼‰', checked: false, suggestion: 'å„ªåŒ–ï¼šçµæ§‹åŒ–æè¿°ã€å°æ¯”è¡¨æ ¼' },
            { id: 'e_i3', text: 'åƒ¹æ ¼ã€æŠ˜æ‰£é¡¯ç¤ºæ˜¯å¦æ¸…æ¥šï¼Ÿ', checked: false, suggestion: 'é€æ˜ï¼šåŸåƒ¹ã€æŠ˜æ‰£ã€é‹è²»ä¸€ç›®äº†ç„¶' },
            { id: 'e_i4', text: 'è³¼ç‰©è»Šåœ–ç¤ºèˆ‡å•†å“æ•¸é‡æç¤ºæ˜¯å¦æ˜é¡¯ï¼Ÿ', checked: false, suggestion: 'è¨­è¨ˆï¼šå›ºå®šæ‡¸æµ®æŒ‰éˆ•ã€æ•¸å­—å¾½ç« ' },
            { id: 'e_i5', text: 'è¡Œå‹•ç‰ˆå•†å“å¡ç‰‡æ˜¯å¦æ˜“æ–¼ç€è¦½èˆ‡é»æ“Šï¼Ÿ', checked: false, suggestion: 'éŸ¿æ‡‰å¼ï¼šå¤§ç¸®åœ–ã€æ¸…æ™°CTA' }
          ],
          context: [
            { id: 'e_c1', text: 'é¦–æ¬¡è¨ªå®¢èƒ½å¦å¿«é€Ÿç†è§£ç¶²ç«™è³£ä»€éº¼ï¼Ÿ', checked: false, suggestion: 'é¦–é ï¼šæ¸…æ™°åƒ¹å€¼ä¸»å¼µã€ç†±é–€å•†å“' },
            { id: 'e_c2', text: 'æ˜¯å¦æä¾›å®¢æœç®¡é“ï¼Ÿï¼ˆç·šä¸Šå®¢æœã€FAQï¼‰', checked: false, suggestion: 'å³æ™‚ï¼šèŠå¤©æ©Ÿå™¨äººã€å¸¸è¦‹å•é¡Œ' },
            { id: 'e_c3', text: 'ç¶²ç«™è¼‰å…¥é€Ÿåº¦æ˜¯å¦å¤ å¿«ï¼Ÿï¼ˆç‰¹åˆ¥æ˜¯å•†å“åœ–ç‰‡ï¼‰', checked: false, suggestion: 'å„ªåŒ–ï¼šåœ–ç‰‡å£“ç¸®ã€CDNåŠ é€Ÿ' },
            { id: 'e_c4', text: 'æ˜¯å¦æ”¯æ´è¨ªå®¢çµå¸³ï¼Ÿï¼ˆç„¡éœ€å¼·åˆ¶è¨»å†Šï¼‰', checked: false, suggestion: 'å½ˆæ€§ï¼šè¨ªå®¢çµå¸³é™ä½é–€æª»' },
            { id: 'e_c5', text: 'æ˜¯å¦æœ‰ä¿¡ä»»æŒ‡æ¨™ï¼Ÿï¼ˆè©•è«–ã€èªè­‰ã€é€€æ¬¾ä¿è­‰ï¼‰', checked: false, suggestion: 'å»ºç«‹ä¿¡ä»»ï¼šç”¨æˆ¶è©•åƒ¹ã€å®‰å…¨æ¨™ç« ' }
          ]
        }
      },
      {
        id: 'education',
        name: 'æ•™è‚²å¹³å°',
        icon: 'ğŸ“š',
        desc: 'èª²ç¨‹ã€å­¸ç¿’ã€é€²åº¦',
        template: {
          process: [
            { id: 'ed_p1', text: 'èª²ç¨‹æœå°‹èˆ‡ç¯©é¸æ˜¯å¦ç›´è¦ºï¼Ÿ', checked: false, suggestion: 'å»ºè­°ï¼šä¾é¡åˆ¥ã€é›£åº¦ã€è©•åˆ†ç¯©é¸' },
            { id: 'ed_p2', text: 'è¨»å†Š/ç™»å…¥æµç¨‹æ˜¯å¦ç°¡æ½”ï¼Ÿ', checked: false, suggestion: 'å„ªåŒ–ï¼šç¤¾ç¾¤ç™»å…¥ã€å–®é è¨»å†Š' },
            { id: 'ed_p3', text: 'è³¼è²·èª²ç¨‹æµç¨‹æ˜¯å¦é †æš¢ï¼Ÿ', checked: false, suggestion: 'ç°¡åŒ–ï¼šå¿«é€Ÿçµå¸³ã€è©¦çœ‹åŠŸèƒ½' },
            { id: 'ed_p4', text: 'å­¸ç¿’é€²åº¦æ˜¯å¦èƒ½è‡ªå‹•å„²å­˜èˆ‡åŒæ­¥ï¼Ÿ', checked: false, suggestion: 'å¿…å‚™ï¼šè·¨è£ç½®å­¸ç¿’é€²åº¦åŒæ­¥' },
            { id: 'ed_p5', text: 'ä½œæ¥­æäº¤èˆ‡æ‰¹æ”¹æµç¨‹æ˜¯å¦æ¸…æ¥šï¼Ÿ', checked: false, suggestion: 'æ˜ç¢ºï¼šæˆªæ­¢æ—¥æœŸã€æäº¤ç‹€æ…‹' }
          ],
          interface: [
            { id: 'ed_i1', text: 'èª²ç¨‹å°èˆªæ˜¯å¦æ¸…æ™°ï¼Ÿï¼ˆç« ç¯€ã€å–®å…ƒï¼‰', checked: false, suggestion: 'è¨­è¨ˆï¼šå´é‚Šæ¬„ç›®éŒ„ã€é€²åº¦æ¢' },
            { id: 'ed_i2', text: 'å½±ç‰‡æ’­æ”¾å™¨æ˜¯å¦æ˜“ç”¨ï¼Ÿï¼ˆé€Ÿåº¦èª¿æ•´ã€å­—å¹•ï¼‰', checked: false, suggestion: 'åŠŸèƒ½ï¼šå€é€Ÿæ’­æ”¾ã€é‡é»ç­†è¨˜' },
            { id: 'ed_i3', text: 'å­¸ç¿’å„€è¡¨æ¿æ˜¯å¦ä¸€ç›®äº†ç„¶ï¼Ÿ', checked: false, suggestion: 'è¦–è¦ºï¼šå­¸ç¿’æ™‚æ•¸ã€å®Œæˆèª²ç¨‹ã€æˆå°±' },
            { id: 'ed_i4', text: 'èª²ç¨‹è³‡æ–™ä¸‹è¼‰æ˜¯å¦æ–¹ä¾¿ï¼Ÿï¼ˆè¬›ç¾©ã€ä½œæ¥­ï¼‰', checked: false, suggestion: 'ä¾¿åˆ©ï¼šä¸€éµä¸‹è¼‰å…¨éƒ¨è³‡æ–™' },
            { id: 'ed_i5', text: 'è¨è«–å€èˆ‡å•ç­”åŠŸèƒ½æ˜¯å¦æ˜“æ–¼ä½¿ç”¨ï¼Ÿ', checked: false, suggestion: 'äº’å‹•ï¼šæ¨™ç±¤åˆ†é¡ã€æœå°‹åŠŸèƒ½' }
          ],
          context: [
            { id: 'ed_c1', text: 'æ–°å­¸å“¡èƒ½å¦å¿«é€Ÿæ‰¾åˆ°é©åˆçš„èª²ç¨‹ï¼Ÿ', checked: false, suggestion: 'å¼•å°ï¼šæ¨è–¦ç³»çµ±ã€å­¸ç¿’è·¯å¾‘' },
            { id: 'ed_c2', text: 'æ˜¯å¦æä¾›è©¦çœ‹æˆ–å…è²»èª²ç¨‹ï¼Ÿ', checked: false, suggestion: 'é™ä½é–€æª»ï¼šè©¦çœ‹ 10åˆ†é˜' },
            { id: 'ed_c3', text: 'æ˜¯å¦æ”¯æ´é›¢ç·šå­¸ç¿’ï¼Ÿ', checked: false, suggestion: 'å½ˆæ€§ï¼šä¸‹è¼‰èª²ç¨‹é›¢ç·šè§€çœ‹' },
            { id: 'ed_c4', text: 'æ˜¯å¦æœ‰å­¸ç¿’æé†’èˆ‡æ¿€å‹µæ©Ÿåˆ¶ï¼Ÿ', checked: false, suggestion: 'æŒçºŒå­¸ç¿’ï¼šæ¯æ—¥æé†’ã€æˆå°±å¾½ç« ' },
            { id: 'ed_c5', text: 'è¡Œå‹•è£ç½®å­¸ç¿’é«”é©—æ˜¯å¦æµæš¢ï¼Ÿ', checked: false, suggestion: 'å„ªåŒ–ï¼šéŸ¿æ‡‰å¼è¨­è¨ˆã€è§¸æ§å‹å–„' }
          ]
        }
      },
      {
        id: 'onboarding',
        name: 'App å¼•å°',
        icon: 'ğŸš€',
        desc: 'æ–°æ‰‹æ•™å­¸ã€æ¬Šé™',
        template: {
          process: [
            { id: 'ob_p1', text: 'é¦–æ¬¡å•Ÿå‹•æ™‚ï¼Œåƒ¹å€¼ä¸»å¼µæ˜¯å¦æ¸…æ™°ï¼Ÿ', checked: false, suggestion: 'å»ºè­°ï¼š3ç§’å…§èªªæ˜æ ¸å¿ƒåƒ¹å€¼' },
            { id: 'ob_p2', text: 'è¨»å†Šæµç¨‹æ˜¯å¦ç°¡æ½”ï¼Ÿï¼ˆ3æ­¥é©Ÿå…§å®Œæˆï¼‰', checked: false, suggestion: 'å„ªåŒ–ï¼šå»¶å¾Œéå¿…è¦è³‡è¨Šæ”¶é›†' },
            { id: 'ob_p3', text: 'å¼•å°æµç¨‹æ˜¯å¦å¯è·³éï¼Ÿ', checked: false, suggestion: 'å½ˆæ€§ï¼šæä¾›ã€Œè·³éã€é¸é …' },
            { id: 'ob_p4', text: 'æ¬Šé™è«‹æ±‚æ˜¯å¦åœ¨é©ç•¶æ™‚æ©Ÿå‡ºç¾ï¼Ÿ', checked: false, suggestion: 'æ™‚æ©Ÿï¼šç”¨åˆ°æ‰è«‹æ±‚ï¼Œèªªæ˜åŸå› ' },
            { id: 'ob_p5', text: 'å®Œæˆå¼•å°å¾Œï¼Œä½¿ç”¨è€…æ˜¯å¦çŸ¥é“ä¸‹ä¸€æ­¥ï¼Ÿ', checked: false, suggestion: 'æ˜ç¢ºï¼šCTA å¼•å°ç¬¬ä¸€å€‹è¡Œå‹•' }
          ],
          interface: [
            { id: 'ob_i1', text: 'å¼•å°ç•«é¢æ˜¯å¦è¦–è¦ºå‹å–„ï¼Ÿï¼ˆæ’åœ–ã€å‹•ç•«ï¼‰', checked: false, suggestion: 'è¨­è¨ˆï¼šç°¡æ½”æ’åœ–ã€æµæš¢å‹•ç•«' },
            { id: 'ob_i2', text: 'é€²åº¦æŒ‡ç¤ºå™¨æ˜¯å¦æ¸…æ¥šï¼Ÿï¼ˆç¬¬å¹¾æ­¥/å…±å¹¾æ­¥ï¼‰', checked: false, suggestion: 'è¦–è¦ºï¼šé€²åº¦é»ã€ç™¾åˆ†æ¯”' },
            { id: 'ob_i3', text: 'æ–‡å­—èªªæ˜æ˜¯å¦ç°¡æ½”æ˜“æ‡‚ï¼Ÿï¼ˆé¿å…å°ˆæ¥­è¡“èªï¼‰', checked: false, suggestion: 'æ–‡æ¡ˆï¼šå£èªåŒ–ã€é—œæ³¨åˆ©ç›Šé»' },
            { id: 'ob_i4', text: 'æŒ‰éˆ•è¨­è¨ˆæ˜¯å¦æ˜ç¢ºï¼Ÿï¼ˆç¹¼çºŒã€è·³éã€å®Œæˆï¼‰', checked: false, suggestion: 'æ¸…æ™°ï¼šä¸»è¦CTAçªå‡º' },
            { id: 'ob_i5', text: 'æ˜¯å¦æ”¯æ´æ‰‹å‹¢æ“ä½œï¼Ÿï¼ˆæ»‘å‹•åˆ‡æ›ï¼‰', checked: false, suggestion: 'äº’å‹•ï¼šæ»‘å‹•æ›é ã€é»æ“Šè·³è½‰' }
          ],
          context: [
            { id: 'ob_c1', text: 'å¼•å°å…§å®¹æ˜¯å¦èƒ½å€‹äººåŒ–ï¼Ÿï¼ˆä¾ç”¨æˆ¶é¡å‹ï¼‰', checked: false, suggestion: 'æ™ºèƒ½ï¼šä¾ä½¿ç”¨æƒ…å¢ƒèª¿æ•´' },
            { id: 'ob_c2', text: 'æ˜¯å¦æä¾›äº’å‹•å¼æ•™å­¸ï¼Ÿï¼ˆè€Œéç´”æ–‡å­—ï¼‰', checked: false, suggestion: 'é«”é©—ï¼šè®“ç”¨æˆ¶å¯¦éš›æ“ä½œ' },
            { id: 'ob_c3', text: 'å¼•å°çµæŸå¾Œï¼Œæ˜¯å¦å¯é‡æ–°æŸ¥çœ‹ï¼Ÿ', checked: false, suggestion: 'å¹«åŠ©ï¼šè¨­å®šä¸­æä¾›æ•™å­¸é‡æ’­' },
            { id: 'ob_c4', text: 'é¦–æ¬¡ä½¿ç”¨æ˜¯å¦æœ‰ç¯„ä¾‹è³‡æ–™ï¼Ÿ', checked: false, suggestion: 'é™ä½é–€æª»ï¼šé è¼‰ç¯„ä¾‹å…§å®¹' },
            { id: 'ob_c5', text: 'æ˜¯å¦è¿½è¹¤å¼•å°å®Œæˆç‡ï¼Ÿï¼ˆå„ªåŒ–å¼±é»ï¼‰', checked: false, suggestion: 'æ•¸æ“šï¼šåˆ†ææµå¤±æ­¥é©Ÿ' }
          ]
        }
      },
      {
        id: 'saas',
        name: 'SaaS å·¥å…·',
        icon: 'âš™ï¸',
        desc: 'å”ä½œã€è¨‚é–±ã€å„€è¡¨æ¿',
        template: {
          process: [
            { id: 'saas_p1', text: 'å…è²»è©¦ç”¨æµç¨‹æ˜¯å¦ç°¡å–®ï¼Ÿï¼ˆç„¡éœ€ä¿¡ç”¨å¡ï¼‰', checked: false, suggestion: 'é™ä½é–€æª»ï¼šå…å¡è©¦ç”¨' },
            { id: 'saas_p2', text: 'è³‡æ–™åŒ¯å…¥/åŒ¯å‡ºæ˜¯å¦æ–¹ä¾¿ï¼Ÿ', checked: false, suggestion: 'å¿…å‚™ï¼šæ”¯æ´å¤šç¨®æ ¼å¼' },
            { id: 'saas_p3', text: 'åœ˜éšŠå”ä½œé‚€è«‹æµç¨‹æ˜¯å¦é †æš¢ï¼Ÿ', checked: false, suggestion: 'ä¾¿åˆ©ï¼šEmail é‚€è«‹ã€è§’è‰²ç®¡ç†' },
            { id: 'saas_p4', text: 'è¨‚é–±å‡ç´š/é™ç´šæµç¨‹æ˜¯å¦æ¸…æ¥šï¼Ÿ', checked: false, suggestion: 'é€æ˜ï¼šæ–¹æ¡ˆæ¯”è¼ƒã€ç„¡ç—›åˆ‡æ›' },
            { id: 'saas_p5', text: 'å–æ¶ˆè¨‚é–±æ˜¯å¦å®¹æ˜“ï¼Ÿï¼ˆä¸åˆ»æ„åˆé›£ï¼‰', checked: false, suggestion: 'èª ä¿¡ï¼šç°¡å–®å–æ¶ˆå»ºç«‹ä¿¡ä»»' }
          ],
          interface: [
            { id: 'saas_i1', text: 'å„€è¡¨æ¿æ˜¯å¦æ¸…æ™°å±•ç¤ºé—œéµæ•¸æ“šï¼Ÿ', checked: false, suggestion: 'è¨­è¨ˆï¼šå¡ç‰‡å¼å¸ƒå±€ã€åœ–è¡¨è¦–è¦ºåŒ–' },
            { id: 'saas_i2', text: 'è¨­å®šé¸é …æ˜¯å¦æ˜“æ–¼æ‰¾åˆ°èˆ‡èª¿æ•´ï¼Ÿ', checked: false, suggestion: 'çµ„ç¹”ï¼šåˆ†é¡æ¸…æ¥šã€æœå°‹åŠŸèƒ½' },
            { id: 'saas_i3', text: 'é€šçŸ¥ç³»çµ±æ˜¯å¦ä¸éåº¦æ‰“æ“¾ï¼Ÿ', checked: false, suggestion: 'å¹³è¡¡ï¼šé‡è¦é€šçŸ¥ã€å¯è‡ªè¨‚' },
            { id: 'saas_i4', text: 'æœå°‹åŠŸèƒ½æ˜¯å¦å¼·å¤§ä¸”å¿«é€Ÿï¼Ÿ', checked: false, suggestion: 'å¿…å‚™ï¼šå…¨å±€æœå°‹ã€å¿«æ·éµ' },
            { id: 'saas_i5', text: 'æ·±è‰²æ¨¡å¼æ”¯æ´æ˜¯å¦å®Œæ•´ï¼Ÿ', checked: false, suggestion: 'é«”é©—ï¼šä¿è­·è¦–åŠ›ã€ç¯€çœé›»åŠ›' }
          ],
          context: [
            { id: 'saas_c1', text: 'ç”¢å“å°è¦½æ˜¯å¦é‡å°ä¸åŒè§’è‰²ï¼Ÿ', checked: false, suggestion: 'å€‹äººåŒ–ï¼šç®¡ç†å“¡vsä½¿ç”¨è€…' },
            { id: 'saas_c2', text: 'æ˜¯å¦æä¾›APIæ–‡ä»¶èˆ‡æ•´åˆæ”¯æ´ï¼Ÿ', checked: false, suggestion: 'æ“´å±•æ€§ï¼šé–‹æ”¾APIã€Webhook' },
            { id: 'saas_c3', text: 'å®¢æœå›æ‡‰é€Ÿåº¦æ˜¯å¦å¿«é€Ÿï¼Ÿ', checked: false, suggestion: 'ä¿è­‰ï¼šSLAæ‰¿è«¾ã€å¤šç®¡é“æ”¯æ´' },
            { id: 'saas_c4', text: 'æ˜¯å¦æœ‰å®Œæ•´çš„èªªæ˜æ–‡ä»¶èˆ‡å½±ç‰‡æ•™å­¸ï¼Ÿ', checked: false, suggestion: 'è‡ªåŠ©ï¼šçŸ¥è­˜åº«ã€å½±ç‰‡åº«' },
            { id: 'saas_c5', text: 'è³‡æ–™å®‰å…¨èˆ‡éš±ç§ä¿è­·æ˜¯å¦æ¸…æ¥šèªªæ˜ï¼Ÿ', checked: false, suggestion: 'ä¿¡ä»»ï¼šèªè­‰æ¨™ç« ã€éš±ç§æ”¿ç­–' }
          ]
        }
      },
      {
        id: 'general',
        name: 'é€šç”¨æ¨¡æ¿',
        icon: 'ğŸ“‹',
        desc: 'åŸºç¤ç—›é»æª¢æŸ¥',
        template: {
          process: [
            { id: 'p1', text: 'è¨»å†Š/ç™»å…¥æµç¨‹æ˜¯å¦éæ–¼è¤‡é›œæˆ–æ­¥é©Ÿéå¤šï¼Ÿ', checked: false, suggestion: 'å»ºè­°ï¼šç¤¾ç¾¤ç™»å…¥ã€æ¸›å°‘å¿…å¡«æ¬„ä½' },
            { id: 'p2', text: 'ä½¿ç”¨è€…èƒ½å¦æ¸…æ¥šç†è§£ä¸‹ä¸€æ­¥è©²åšä»€éº¼ï¼Ÿ', checked: false, suggestion: 'å„ªåŒ–ï¼šæ¸…æ™°CTAã€å¼•å°æç¤º' },
            { id: 'p3', text: 'å®Œæˆæ ¸å¿ƒä»»å‹™éœ€è¦ç¶“éå¹¾å€‹æ­¥é©Ÿï¼Ÿæ˜¯å¦å¯ä»¥ç°¡åŒ–ï¼Ÿ', checked: false, suggestion: 'ç²¾ç°¡ï¼š3æ­¥é©Ÿå…§å®Œæˆä¸»è¦ä»»å‹™' },
            { id: 'p4', text: 'éŒ¯èª¤è™•ç†æ©Ÿåˆ¶æ˜¯å¦æ˜ç¢ºï¼Ÿä½¿ç”¨è€…çŸ¥é“å¦‚ä½•ä¿®æ­£éŒ¯èª¤å—ï¼Ÿ', checked: false, suggestion: 'å‹å–„ï¼šå…·é«”éŒ¯èª¤è¨Šæ¯ã€ä¿®æ­£å»ºè­°' },
            { id: 'p5', text: 'æ˜¯å¦æœ‰ä¸å¿…è¦çš„ç¢ºèªæ­¥é©Ÿæˆ–é‡è¤‡æ“ä½œï¼Ÿ', checked: false, suggestion: 'æµæš¢ï¼šæ¸›å°‘æ‘©æ“¦é»' }
          ],
          interface: [
            { id: 'i1', text: 'CTA æŒ‰éˆ•æ˜¯å¦è¶³å¤ æ˜é¡¯ï¼Ÿä½ç½®æ˜¯å¦ç¬¦åˆä½¿ç”¨è€…é æœŸï¼Ÿ', checked: false, suggestion: 'è¨­è¨ˆï¼šå°æ¯”è‰²ã€Få‹é–±è®€è·¯å¾‘' },
            { id: 'i2', text: 'å°è¦½åˆ—æ˜¯å¦æ¸…æ™°ï¼Ÿä½¿ç”¨è€…èƒ½å¦å¿«é€Ÿæ‰¾åˆ°ç›®æ¨™åŠŸèƒ½ï¼Ÿ', checked: false, suggestion: 'çµæ§‹ï¼šæ‰å¹³åŒ–ã€æœå°‹åŠŸèƒ½' },
            { id: 'i3', text: 'è¡¨å–®è¨­è¨ˆæ˜¯å¦å‹å–„ï¼Ÿæ¬„ä½æ¨™ç±¤æ˜¯å¦æ¸…æ¥šï¼Ÿ', checked: false, suggestion: 'æ˜“ç”¨ï¼šå…§åµŒæ¨™ç±¤ã€å³æ™‚é©—è­‰' },
            { id: 'i4', text: 'è¦–è¦ºå±¤ç´šæ˜¯å¦åˆç†ï¼Ÿé‡è¦è³‡è¨Šæ˜¯å¦çªå‡ºï¼Ÿ', checked: false, suggestion: 'è¦–è¦ºï¼šå¤§å°ã€é¡è‰²ã€ä½ç½®' },
            { id: 'i5', text: 'è¡Œå‹•è£ç½®ä¸Šçš„å¯é»æ“Šå€åŸŸæ˜¯å¦å¤ å¤§ï¼ˆè‡³å°‘ 44Ã—44pxï¼‰ï¼Ÿ', checked: false, suggestion: 'è§¸æ§ï¼šè¶³å¤ é»æ“Šå€åŸŸ' }
          ],
          context: [
            { id: 'c1', text: 'ä½¿ç”¨æƒ…å¢ƒæ˜¯å¦ç¬¦åˆç›®æ¨™ä½¿ç”¨è€…çš„çœŸå¯¦éœ€æ±‚ï¼Ÿ', checked: false, suggestion: 'ç”¨æˆ¶ç ”ç©¶ï¼šè¨ªè«‡ã€è§€å¯Ÿ' },
            { id: 'c2', text: 'æ˜¯å¦è€ƒæ…®åˆ°ä¸åŒè£ç½®ï¼ˆæ‰‹æ©Ÿ/å¹³æ¿/æ¡Œæ©Ÿï¼‰çš„ä½¿ç”¨æƒ…å¢ƒï¼Ÿ', checked: false, suggestion: 'éŸ¿æ‡‰å¼ï¼šå„å°ºå¯¸æ¸¬è©¦' },
            { id: 'c3', text: 'é¦–æ¬¡ä½¿ç”¨è€…æ˜¯å¦èƒ½ç†è§£ç”¢å“åƒ¹å€¼èˆ‡ä½¿ç”¨æ–¹æ³•ï¼Ÿ', checked: false, suggestion: 'æ¸…æ™°ï¼šåƒ¹å€¼ä¸»å¼µã€å¼•å°æµç¨‹' },
            { id: 'c4', text: 'æ˜¯å¦æœ‰è€ƒæ…®åˆ°ç¶²è·¯ä¸ç©©å®šæˆ–è¼‰å…¥ç·©æ…¢çš„æƒ…æ³ï¼Ÿ', checked: false, suggestion: 'é«”é©—ï¼šé›¢ç·šæ¨¡å¼ã€éª¨æ¶å±' },
            { id: 'c5', text: 'å¤šèªç³»ä½¿ç”¨è€…æ˜¯å¦èƒ½é †æš¢ä½¿ç”¨ï¼Ÿï¼ˆä¸­è‹±æ–‡åˆ‡æ›ã€æ–‡å­—é•·åº¦ï¼‰', checked: false, suggestion: 'åœ‹éš›åŒ–ï¼ši18nã€å½ˆæ€§å¸ƒå±€' }
          ]
        }
      }
    ];

    let userEmail = '';
    let userChecklists = [];
    let isPaid = false;
    let selectedProjectType = null;
    const FREE_LIMIT = 3;

    // Undo State
    let undoTimer = null;
    let lastDeleted = null; // { data, index }

    // UI Elements
    const elements = {
      loading: document.getElementById('loading-overlay'),
      emptyState: document.getElementById('empty-state'),
      container: document.getElementById('checklists-container'),
      createBtn: document.getElementById('create-checklist-btn'),
      userStatus: document.getElementById('user-status'),
      checklistCount: document.getElementById('checklist-count'),
      checklistLimit: document.getElementById('checklist-limit'),
      limitNotice: document.getElementById('limit-notice')
    };

    // Hide Loading
    const hideLoading = () => elements.loading.style.display = 'none';

    // Load User Data
    async function loadUserData(email) {
      const uid = (auth.currentUser && auth.currentUser.uid) || '';
      const refEmail = doc(db, 'users_by_email', encEmail(email));
      const refUid = uid ? doc(db, 'users', uid) : null;

      let emailData = null;
      let uidData = null;

      // Read both paths (sequential to keep it simple and robust to auth state)
      try {
        const snapEmail = await getDoc(refEmail);
        if (snapEmail.exists()) emailData = snapEmail.data();
      } catch (err) {
        console.warn('è®€å– users_by_email å¤±æ•—ï¼š', err?.message || err);
      }
      try {
        if (refUid) {
          const snapUid = await getDoc(refUid);
          if (snapUid.exists()) uidData = snapUid.data();
        }
      } catch (err2) {
        console.warn('è®€å– users/{uid} å¤±æ•—ï¼š', err2?.message || err2);
      }

      const emailLists = (emailData && Array.isArray(emailData.uxChecklists)) ? emailData.uxChecklists : [];
      const uidLists = (uidData && Array.isArray(uidData.uxChecklists)) ? uidData.uxChecklists : [];

      // Prefer non-empty source; otherwise prefer users_by_email if present; else users/{uid}; else init
      let source = 'none';
      if (emailLists.length > 0) {
        userChecklists = emailLists;
        source = 'users_by_email';
      } else if (uidLists.length > 0) {
        userChecklists = uidLists;
        source = 'users_uid';
      } else if (emailData) {
        userChecklists = emailLists;
        source = 'users_by_email';
      } else if (uidData) {
        userChecklists = uidLists;
        source = 'users_uid';
      } else {
        userChecklists = [];
        source = 'none';
      }

      // Merge membership flags (prefer true if any source has it)
      isPaid = Boolean((emailData && emailData.isPaid) || (uidData && uidData.isPaid));
      elements.userStatus.textContent = isPaid ? 'ä»˜è²»æœƒå“¡' : 'å…è²»æœƒå“¡';
      elements.checklistLimit.textContent = isPaid ? 'âˆ' : FREE_LIMIT;

      // If we used users/{uid} as source and have lists, try to sync into users_by_email for future reads
      if (source === 'users_uid' && userChecklists.length > 0) {
        try {
          await setDoc(refEmail, { email, uxChecklists: JSON.parse(JSON.stringify(userChecklists)) }, { merge: true });
          console.log('â†ª å·²åŒæ­¥æ¸…å–®åˆ° users_by_email');
        } catch (syncErr) {
          console.warn('åŒæ­¥åˆ° users_by_email å¤±æ•—ï¼ˆå¯å¿½ç•¥ï¼‰ï¼š', syncErr?.message || syncErr);
        }
      }

      // If neither path existed, initialize primary doc (email-keyed)
      if (source === 'none') {
        try {
          await setDoc(refEmail, { email, uxChecklists: [] }, { merge: true });
          console.log('å·²åˆå§‹åŒ–ä½¿ç”¨è€…æ–‡ä»¶ users_by_email');
        } catch (initErr) {
          console.error('åˆå§‹åŒ–ä½¿ç”¨è€…æ–‡ä»¶å¤±æ•—ï¼š', initErr);
        }
      }

      updateUI();
    }

    // Update UI
    function updateUI() {
      elements.checklistCount.textContent = userChecklists.length;

      // Check limit
      const reachedLimit = !isPaid && userChecklists.length >= FREE_LIMIT;
      elements.createBtn.disabled = reachedLimit;
      elements.limitNotice.classList.toggle('d-none', !reachedLimit);

      // Show/Hide empty state
      if (userChecklists.length === 0) {
        elements.emptyState.style.display = 'block';
        return;
      } else {
        elements.emptyState.style.display = 'none';
      }

      // Render checklists
      const checklistsHtml = userChecklists.map((checklist, index) => 
        renderChecklist(checklist, index)
      ).join('');

      elements.container.innerHTML = checklistsHtml;

      // Attach event listeners
      attachEventListeners();
    }

    // Render Single Checklist
    function renderChecklist(checklist, index) {
      const totalItems = checklist.items.process.length + checklist.items.interface.length + checklist.items.context.length;
      const checkedItems = [
        ...checklist.items.process,
        ...checklist.items.interface,
        ...checklist.items.context
      ].filter(item => item.checked).length;
      const progress = Math.round((checkedItems / totalItems) * 100);
      const isCompleted = progress >= 80;
      
      const projectType = projectTypes.find(pt => pt.id === checklist.projectType) || projectTypes.find(pt => pt.id === 'general');

      // helper to safely embed suggestion text for data-attributes
      const encAttr = (s) => encodeURIComponent(s || '');

      // Build section items without nested template literals (robust parsing)
      const renderItem = (cat, item) => {
        return '<div class="checklist-item ' + (item.checked ? 'checked' : '') + '">' +
               '<input type="checkbox" ' +
               'id="check-' + index + '-' + item.id + '" ' +
               (item.checked ? 'checked' : '') + ' ' +
               'onchange="window.toggleCheckbox(' + index + ', &quot;' + cat + '&quot;, &quot;' + item.id + '&quot;)">' +
               '<div class="checklist-item-text">' +
               item.text +
               (item.suggestion ? ('<div class="suggestion-pill" data-suggestion="' + encAttr(item.suggestion) + '"><i class="fas fa-lightbulb"></i> å»ºè­°</div>') : '') +
               '</div>' +
               '</div>';
      };

      const processHtml = checklist.items.process.map(item => renderItem('process', item)).join('');
      const interfaceHtml = checklist.items.interface.map(item => renderItem('interface', item)).join('');
      const contextHtml = checklist.items.context.map(item => renderItem('context', item)).join('');

      return `
        <div class="checklist-card ${isCompleted ? 'completed' : ''}" data-index="${index}">
          <div class="checklist-header">
            <input type="text" value="${checklist.name}" 
                   class="checklist-name-input" 
                   data-index="${index}"
                   placeholder="æ¸…å–®åç¨±">
            <div class="checklist-actions no-print">
              <button class="action-btn duplicate" data-action="duplicate" title="è¤‡è£½æ¸…å–®">
                <i class="fas fa-copy"></i> è¤‡è£½
              </button>
              <button class="action-btn print" data-action="print" title="åˆ—å°æ¸…å–®">
                <i class="fas fa-print"></i> åˆ—å°
              </button>
              <button class="action-btn delete" data-action="delete" title="åˆªé™¤æ¸…å–®">
                <i class="fas fa-trash"></i> åˆªé™¤
              </button>
            </div>
          </div>

          <div class="checklist-meta">
            <span class="checklist-badge project-type">
              <span>${projectType.icon}</span>
              <span>${projectType.name}</span>
            </span>
            <span class="checklist-badge">
              <i class="fas fa-clock"></i>
              æ›´æ–°ï¼š${new Date(checklist.updatedAt).toLocaleDateString('zh-TW')}
            </span>
          </div>

          <div class="progress-wrapper">
            <div class="progress">
              <div class="progress-bar ${progress === 100 ? 'complete' : ''}" style="width: ${progress}%"></div>
            </div>
            <div class="progress-label">
              <span>${checkedItems} / ${totalItems} é …å®Œæˆ</span>
              <span class="fw-bold">${progress}%</span>
            </div>
          </div>

          <!-- Process Category -->
          <div class="checklist-section">
            <div class="section-title">
              <div class="section-icon process">
                <i class="fas fa-route"></i>
              </div>
              <span>æµç¨‹ç—›é»</span>
            </div>
            ${processHtml}
          </div>

          <!-- Interface Category -->
          <div class="checklist-section">
            <div class="section-title">
              <div class="section-icon interface">
                <i class="fas fa-window-maximize"></i>
              </div>
              <span>ä»‹é¢ç—›é»</span>
            </div>
            ${interfaceHtml}
          </div>

          <!-- Context Category -->
          <div class="checklist-section">
            <div class="section-title">
              <div class="section-icon context">
                <i class="fas fa-users"></i>
              </div>
              <span>æƒ…å¢ƒç—›é»</span>
            </div>
            ${contextHtml}
          </div>
        </div>

          `;
            }

            // Show Achievement Toast
    function showAchievement(text) {
      const toast = document.getElementById('achievement-toast');
      const textEl = document.getElementById('achievement-text');
      textEl.textContent = text;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 5000);
    }

    // Show Save Indicator
    function showSaveIndicator() {
      const indicator = document.getElementById('save-indicator');
      indicator.classList.add('show');
      setTimeout(() => indicator.classList.remove('show'), 2000);
    }

    // Undo Toast helpers
    function showUndoToast(message, onUndo) {
      clearTimeout(undoTimer);
      const toast = document.getElementById('undo-toast');
      const textEl = document.getElementById('undo-text');
      const btn = document.getElementById('undo-btn');
      textEl.textContent = message;
      toast.classList.add('show');
      btn.onclick = () => {
        clearTimeout(undoTimer);
        toast.classList.remove('show');
        if (typeof onUndo === 'function') onUndo();
      };
      undoTimer = setTimeout(() => {
        toast.classList.remove('show');
      }, 5000);
    }

    // Suggestion click (delegated) - avoids inline onclick parsing issues
    elements.container.addEventListener('click', (e) => {
      // suggestion pill
      const pill = e.target.closest('.suggestion-pill');
      if (pill) {
        try {
          const text = decodeURIComponent(pill.dataset.suggestion || '');
          alert(text || 'ï¼ˆç„¡å»ºè­°å…§å®¹ï¼‰');
        } catch (err) {
          alert('ç„¡æ³•è®€å–å»ºè­°å…§å®¹');
        }
        return;
      }
      // action buttons (duplicate/print/delete)
      const btn = e.target.closest('button[data-action]');
      if (btn) {
        const card = e.target.closest('.checklist-card');
        if (!card) return;
        const idx = parseInt(card.dataset.index);
        const action = btn.dataset.action;
        if (action === 'duplicate') {
          window.duplicateChecklistWithUI ? window.duplicateChecklistWithUI(idx, btn) : (window.duplicateChecklist && window.duplicateChecklist(idx));
        } else if (action === 'delete') {
          window.deleteChecklistWithUI ? window.deleteChecklistWithUI(idx, btn) : (window.deleteChecklist && window.deleteChecklist(idx));
        } else if (action === 'print') {
          window.print && window.print();
        }
        return;
      }
    });

    // Initialize Project Type Modal
    function initProjectTypeModal() {
      const grid = document.getElementById('project-type-grid');
      grid.innerHTML = projectTypes.map(pt => `
        <div class="project-type-card" data-type="${pt.id}" onclick="selectProjectType('${pt.id}')">
          <div class="project-type-icon">${pt.icon}</div>
          <div class="project-type-name">${pt.name}</div>
          <div class="project-type-desc">${pt.desc}</div>
        </div>
      `).join('');
    }

    // Select Project Type
    window.selectProjectType = function(typeId) {
      selectedProjectType = typeId;
      document.querySelectorAll('.project-type-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.type === typeId);
      });
    };

    // Create New Checklist with Project Type
    elements.createBtn.addEventListener('click', () => {
      if (!isPaid && userChecklists.length >= FREE_LIMIT) {
        alert('å·²é”å…è²»æœƒå“¡ä¸Šé™ï¼ˆ3 å¼µæ¸…å–®ï¼‰\n\nå‡ç´šåˆ°ä»˜è²»æœƒå“¡ä»¥å»ºç«‹ç„¡é™æ•¸é‡æ¸…å–®ï¼');
        return;
      }
      
      selectedProjectType = null;
      const modal = new bootstrap.Modal(document.getElementById('projectTypeModal'));
      modal.show();
    });

    // Confirm Project Type and Create Checklist
    document.getElementById('confirm-project-type').addEventListener('click', async () => {
      if (!selectedProjectType) {
        alert('è«‹é¸æ“‡å°ˆæ¡ˆé¡å‹');
        return;
      }

      const confirmBtn = document.getElementById('confirm-project-type');
      const cancelBtn = document.querySelector('#projectTypeModal .btn.btn-secondary');
      const setBtnBusy = (btn, label) => {
        if (!btn) return;
        btn.disabled = true;
        btn.dataset.original = btn.innerHTML;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>${label}`;
      };
      const restoreBtn = (btn) => {
        if (!btn || !btn.dataset.original) return;
        btn.innerHTML = btn.dataset.original;
        btn.disabled = false;
        delete btn.dataset.original;
      };
      setBtnBusy(confirmBtn, 'å»ºç«‹ä¸­â€¦');
      if (cancelBtn) cancelBtn.disabled = true;
      const projectType = projectTypes.find(pt => pt.id === selectedProjectType);
      const newChecklist = {
        id: Date.now().toString(),
        name: `${projectType.name} - ${new Date().toLocaleDateString('zh-TW')}`,
        projectType: selectedProjectType,
        items: JSON.parse(JSON.stringify(projectType.template)),
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      userChecklists.push(newChecklist);

      // Save immediately (avoid duplicate listeners/race conditions)
      await saveToFirestore();
      showSaveIndicator();

      // Then close modal safely
      confirmBtn.blur();
      const modalInstance = bootstrap.Modal.getInstance(document.getElementById('projectTypeModal'));
      if (modalInstance) modalInstance.hide();

      // Refresh UI after a short delay for smoother close animation
      setTimeout(() => updateUI(), 100);
      setTimeout(() => {
        restoreBtn(confirmBtn);
        if (cancelBtn) cancelBtn.disabled = false;
      }, 150);
    });

    // Toggle Checkbox with Achievement Check
    window.toggleCheckbox = async (checklistIndex, category, itemId) => {
      const item = userChecklists[checklistIndex].items[category].find(i => i.id === itemId);
      if (item) {
        const wasChecked = item.checked;
        item.checked = !item.checked;
        userChecklists[checklistIndex].updatedAt = new Date().toISOString();
        
        // Check progress for achievement
        const checklist = userChecklists[checklistIndex];
        const totalItems = checklist.items.process.length + checklist.items.interface.length + checklist.items.context.length;
        const checkedItems = [
          ...checklist.items.process,
          ...checklist.items.interface,
          ...checklist.items.context
        ].filter(i => i.checked).length;
        const progress = Math.round((checkedItems / totalItems) * 100);
        
        // Show achievement at 80% completion (only when checking, not unchecking)
        if (!wasChecked && progress >= 80 && progress < 100) {
          showAchievement('ğŸ‰ å¤ªæ£’äº†ï¼ä½ å·²ç¶“å®Œæˆ 80% çš„ç—›é»æª¢æŸ¥');
        } else if (progress === 100 && !wasChecked) {
          showAchievement('ğŸ† å®Œç¾ï¼æ‰€æœ‰ç—›é»æª¢æŸ¥å®Œæˆï¼Œä½ å·²ç¶“æ˜¯ UX è§€å¯Ÿé«˜æ‰‹');
        }
        
        await saveToFirestore();
        showSaveIndicator();
        updateUI();
      }
    };

    // Delete Checklist (basic)
    window.deleteChecklist = async (index) => {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ¸…å–®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;
      const removed = userChecklists[index];
      const restoreAt = index;
      userChecklists.splice(index, 1);
      // Optimistic UI: render immediately
      updateUI();
      lastDeleted = { data: removed, index: restoreAt };
      showUndoToast(`å·²åˆªé™¤ã€Œ${removed?.name || 'æ¸…å–®'}ã€`, async () => {
        const insertAt = Math.min(lastDeleted.index, userChecklists.length);
        userChecklists.splice(insertAt, 0, lastDeleted.data);
        lastDeleted = null;
        updateUI();
        try { await saveToFirestore(); showSaveIndicator(); } catch(e) {}
      });
      // Save in background
      saveToFirestore().then(() => {
        showSaveIndicator();
      }).catch(err => {
        console.warn('åˆªé™¤åŒæ­¥å¤±æ•—ï¼š', err?.message || err);
      });
    };

    // Delete Checklist with UI feedback
    window.deleteChecklistWithUI = async (index, btnEl) => {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ¸…å–®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;
      // Optimistic remove: update UI immediately, save in background, provide undo
      const removed = userChecklists[index];
      const restoreAt = index;
      userChecklists.splice(index, 1);
      updateUI();
      lastDeleted = { data: removed, index: restoreAt };
      showUndoToast(`å·²åˆªé™¤ã€Œ${removed?.name || 'æ¸…å–®'}ã€`, async () => {
        const insertAt = Math.min(lastDeleted.index, userChecklists.length);
        userChecklists.splice(insertAt, 0, lastDeleted.data);
        lastDeleted = null;
        updateUI();
        try { await saveToFirestore(); showSaveIndicator(); } catch(e) {}
      });
      // Save in background
      saveToFirestore().then(() => {
        showSaveIndicator();
      }).catch(err => {
        console.warn('åˆªé™¤åŒæ­¥å¤±æ•—ï¼š', err?.message || err);
      });
    };

    // Duplicate Checklist (basic)
    window.duplicateChecklist = async (index) => {
      if (!isPaid && userChecklists.length >= FREE_LIMIT) {
        alert('å·²é”å…è²»æœƒå“¡ä¸Šé™ï¼ˆ3 å¼µæ¸…å–®ï¼‰\n\nå‡ç´šåˆ°ä»˜è²»æœƒå“¡ä»¥å»ºç«‹ç„¡é™æ•¸é‡æ¸…å–®ï¼');
        return;
      }

      const original = userChecklists[index];
      const duplicate = JSON.parse(JSON.stringify(original));
      duplicate.id = Date.now().toString();
      duplicate.name = `${original.name} (å‰¯æœ¬)`;
      duplicate.createdAt = new Date().toISOString();
      duplicate.updatedAt = new Date().toISOString();

      userChecklists.push(duplicate);
      await saveToFirestore();
      showSaveIndicator();
      updateUI();
    };

    // Duplicate Checklist with UI feedback
    window.duplicateChecklistWithUI = async (index, btnEl) => {
      if (!isPaid && userChecklists.length >= FREE_LIMIT) {
        alert('å·²é”å…è²»æœƒå“¡ä¸Šé™ï¼ˆ3 å¼µæ¸…å–®ï¼‰\n\nå‡ç´šåˆ°ä»˜è²»æœƒå“¡ä»¥å»ºç«‹ç„¡é™æ•¸é‡æ¸…å–®ï¼');
        return;
      }
      const setBtnBusy = (btn, label) => {
        if (!btn) return;
        btn.disabled = true;
        btn.dataset.original = btn.innerHTML;
        btn.innerHTML = `<span class=\"spinner-border spinner-border-sm me-2\" role=\"status\" aria-hidden=\"true\"></span>${label}`;
      };
      const restoreBtn = (btn) => {
        if (!btn || !btn.dataset.original) return;
        btn.innerHTML = btn.dataset.original;
        btn.disabled = false;
        delete btn.dataset.original;
      };
      setBtnBusy(btnEl, 'è¤‡è£½ä¸­â€¦');
      try {
        const original = userChecklists[index];
        const duplicate = JSON.parse(JSON.stringify(original));
        duplicate.id = Date.now().toString();
        duplicate.name = `${original.name} (å‰¯æœ¬)`;
        duplicate.createdAt = new Date().toISOString();
        duplicate.updatedAt = new Date().toISOString();
        userChecklists.push(duplicate);
        await saveToFirestore();
        showSaveIndicator();
        updateUI();
      } catch (e) {
        alert('è¤‡è£½å¤±æ•—ï¼Œè«‹é‡è©¦');
        restoreBtn(btnEl);
      }
    };

    // Attach Event Listeners
    function attachEventListeners() {
      // Name input listeners with debounce
      document.querySelectorAll('.checklist-name-input').forEach(input => {
        let timeout;
        input.addEventListener('input', (e) => {
          clearTimeout(timeout);
          timeout = setTimeout(async () => {
            const index = parseInt(e.target.dataset.index);
            const newName = e.target.value.trim() || `å°ˆæ¡ˆæ¸…å–® ${index + 1}`;
            userChecklists[index].name = newName;
            userChecklists[index].updatedAt = new Date().toISOString();
            await saveToFirestore();
            showSaveIndicator();
          }, 500);
        });
      });
    }

    // Save to Firestore
    async function saveToFirestore() {
      if (!userEmail) {
        console.warn('âš ï¸ å°šæœªç™»å…¥ï¼Œç„¡æ³•å„²å­˜');
        return;
      }
      
      try {
        const cleanChecklists = JSON.parse(JSON.stringify(userChecklists));
        const primaryRef = doc(db, 'users_by_email', encEmail(userEmail));
        
        // Check if document exists to determine operation type
        const snapshot = await getDoc(primaryRef);
        
        if (snapshot.exists()) {
          // Document exists, use update
          await updateDoc(primaryRef, { uxChecklists: cleanChecklists });
        } else {
          // Document doesn't exist, use create
          await setDoc(primaryRef, { email: userEmail, uxChecklists: cleanChecklists });
        }
        console.log('âœ… æ¸…å–®å·²å„²å­˜ (users_by_email)');
      } catch (error) {
        console.warn('users_by_email å„²å­˜å¤±æ•—ï¼Œå˜—è©¦ users/{uid}ï¼š', error?.message || error);
        try {
          const uid = (auth.currentUser && auth.currentUser.uid) || '';
          if (!uid) throw new Error('No UID for fallback write');
          const cleanChecklists = JSON.parse(JSON.stringify(userChecklists));
          const uidRef = doc(db, 'users', uid);
          await setDoc(uidRef, { email: userEmail, uxChecklists: cleanChecklists }, { merge: true });
          console.log('âœ… æ¸…å–®å·²å„²å­˜ (users/{uid})');
        } catch (err2) {
          console.error('âŒ å„²å­˜éŒ¯èª¤ (å…©è·¯å¾‘çš†å¤±æ•—):', err2);
          console.error('æ¸…å–®è³‡æ–™:', userChecklists);
          alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦\n\néŒ¯èª¤è¨Šæ¯ï¼š' + (err2?.message || err2));
        }
      }
    }

    // Auth State
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        hideLoading();
        window.location.href = '/index.html';
        return;
      }

      userEmail = user.email;
      await loadUserData(user.email);
      initProjectTypeModal();
      hideLoading();
      if (window.__uxChecklistOk) window.__uxChecklistOk();
    });
  </script>

</body>
</html>