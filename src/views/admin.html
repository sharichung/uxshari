<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç”¢å“ç®¡ç† | UXShari Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="assets/css/general.css">
  <style>
    body {
      background: #f8f9fa;
    }
    
    .admin-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem 0;
      margin-bottom: 2rem;
    }
    
    .product-form {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .product-list-item {
      background: white;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s;
    }
    
    .product-list-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .product-thumbnail {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 0.5rem;
    }
    
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }
    
    .status-indicator.active {
      background: #10b981;
    }
    
    .status-indicator.inactive {
      background: #ef4444;
    }
  </style>
</head>
<body>

  <div class="admin-header">
    <div class="container">
      <h1><i class="fas fa-tools me-2"></i>ç”¢å“ç®¡ç†ç³»çµ±</h1>
      <p class="mb-0">æ–°å¢ã€ç·¨è¼¯å’Œç®¡ç†æ‚¨çš„æ•¸ä½ç”¢å“</p>
    </div>
  </div>

  <div class="container pb-5">
    
    <!-- ç®¡ç†å“¡é©—è­‰ -->
    <div id="auth-section" class="product-form mb-4">
      <h4 class="mb-3"><i class="fas fa-key me-2"></i>ç®¡ç†å“¡é©—è­‰</h4>
      <div class="row g-3">
        <div class="col-md-10">
          <input type="password" class="form-control" id="admin-key-input" 
                 placeholder="è«‹è¼¸å…¥ç®¡ç†å“¡å¯†é‘° (Admin Key)">
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" id="verify-btn">
            <i class="fas fa-unlock me-2"></i>é©—è­‰
          </button>
        </div>
      </div>
      <div class="alert alert-info mt-3 mb-0 small">
        <i class="fas fa-info-circle me-2"></i>
        è«‹ä½¿ç”¨æ‚¨çš„ ADMIN_KEY é€²è¡Œé©—è­‰å¾Œæ‰èƒ½ç®¡ç†ç”¢å“
      </div>
    </div>

    <!-- ä¸»è¦ç®¡ç†å€åŸŸï¼ˆé©—è­‰å¾Œé¡¯ç¤ºï¼‰ -->
    <div id="admin-area" class="d-none">
      
      <!-- æ–°å¢/ç·¨è¼¯ç”¢å“è¡¨å–® -->
      <div class="product-form mb-4">
        <h4 class="mb-3">
          <i class="fas fa-plus-circle me-2"></i>
          <span id="form-title">æ–°å¢ç”¢å“</span>
        </h4>
        
        <form id="product-form">
          <input type="hidden" id="product-id">
          
          <div class="row g-3">
            <!-- ç”¢å“é¡å‹ -->
            <div class="col-md-6">
              <label class="form-label">ç”¢å“é¡å‹ *</label>
              <select class="form-select" id="product-type" required>
                <option value="tool">ğŸ§° å·¥å…· (Tool)</option>
                <option value="course">ğŸ“š èª²ç¨‹ (Course)</option>
                <option value="challenge">ğŸ¯ æŒ‘æˆ°åŒ… (Challenge)</option>
                <option value="resource">ğŸ“¦ è³‡æºåº« (Resource)</option>
              </select>
            </div>

            <!-- ç”¢å“åç¨± -->
            <div class="col-md-6">
              <label class="form-label">ç”¢å“åç¨± *</label>
              <input type="text" class="form-control" id="product-title" required 
                     placeholder="ä¾‹å¦‚ï¼šUX ç·šæ¡†åœ–æ¨¡æ¿åŒ…">
            </div>

            <!-- ç”¢å“æè¿° -->
            <div class="col-12">
              <label class="form-label">ç”¢å“æè¿° *</label>
              <textarea class="form-control" id="product-description" rows="3" required
                        placeholder="ç°¡çŸ­æè¿°ç”¢å“å…§å®¹èˆ‡åƒ¹å€¼"></textarea>
            </div>

            <!-- åƒ¹æ ¼ -->
            <div class="col-md-4">
              <label class="form-label">åƒ¹æ ¼ (USD) *</label>
              <input type="number" class="form-control" id="product-price" 
                     min="0" step="0.01" required placeholder="9.00">
            </div>

            <!-- é¡åˆ¥ -->
            <div class="col-md-4">
              <label class="form-label">é¡åˆ¥</label>
              <input type="text" class="form-control" id="product-category" 
                     placeholder="ä¾‹å¦‚ï¼šwireframe, persona">
            </div>

            <!-- é›£åº¦ -->
            <div class="col-md-4">
              <label class="form-label">é›£åº¦</label>
              <select class="form-select" id="product-level">
                <option value="beginner">åˆå­¸è€…</option>
                <option value="intermediate">ä¸­ç´š</option>
                <option value="advanced">é€²éš</option>
              </select>
            </div>

            <!-- Stripe Product ID -->
            <div class="col-md-6">
              <label class="form-label">Stripe Product ID</label>
              <input type="text" class="form-control" id="stripe-product-id" 
                     placeholder="prod_1QKm8xHNWqZ9vYjJ"
                     pattern="prod_[a-zA-Z0-9]+">
              <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                å¾ <a href="https://dashboard.stripe.com/products" target="_blank">Stripe Dashboard</a> è¤‡è£½ Product ID
              </small>
            </div>

            <!-- Stripe Price ID -->
            <div class="col-md-6">
              <label class="form-label">Stripe Price ID *</label>
              <input type="text" class="form-control" id="stripe-price-id" required
                     placeholder="price_1QKm8xHNWqZ9vYjJ2L3k4M5n"
                     pattern="price_[a-zA-Z0-9]+">
              <small class="text-danger">
                <i class="fas fa-exclamation-triangle me-1"></i>
                <strong>å¿…å¡«ï¼</strong>å¿…é ˆå¾ Stripe å¯¦éš›å»ºç«‹çš„ Price IDï¼ˆæ ¼å¼ï¼šprice_xxxxxï¼‰
              </small>
            </div>

            <!-- Stripe è¨­å®šæç¤º -->
            <div class="col-12">
              <div class="alert alert-warning">
                <h6><i class="fas fa-lightbulb me-2"></i>Stripe è¨­å®šæ­¥é©Ÿ</h6>
                <ol class="mb-0 small">
                  <li>ç™»å…¥ <a href="https://dashboard.stripe.com/products" target="_blank">Stripe Dashboard</a></li>
                  <li>é»æ“Š <strong>Add product</strong> å»ºç«‹ç”¢å“</li>
                  <li>è¨­å®šåç¨±ã€åƒ¹æ ¼ã€One time ä»˜æ¬¾</li>
                  <li>å„²å­˜å¾Œè¤‡è£½ <strong>Product ID</strong> å’Œ <strong>Price ID</strong></li>
                  <li>è²¼åˆ°ä¸Šæ–¹æ¬„ä½ï¼ˆPrice ID å¿…å¡«ï¼ï¼‰</li>
                </ol>
              </div>
            </div>

            <!-- å°é¢åœ– URL -->
            <div class="col-12">
              <label class="form-label">å°é¢åœ– URL</label>
              <input type="url" class="form-control" id="cover-image" 
                     placeholder="https://images.unsplash.com/photo-xxxxx">
              <small class="text-info">
                <i class="fas fa-image me-1"></i>
                <strong>å»ºè­°è¦æ ¼ï¼š</strong>1200Ã—800px (3:2 æ¯”ä¾‹) | æ ¼å¼ï¼šWebP/JPG | å¤§å°ï¼š&lt;200KB | 
                <a href="https://unsplash.com" target="_blank">Unsplash</a> / 
                <a href="https://www.pexels.com" target="_blank">Pexels</a> å…è²»åœ–åº«
              </small>
            </div>

            <!-- ä¸‹è¼‰/å…§å®¹é€£çµ -->
            <div class="col-md-6">
              <label class="form-label">ä¸‹è¼‰é€£çµ (å·¥å…·/è³‡æº)</label>
              <input type="url" class="form-control" id="download-url" 
                     placeholder="https://...">
            </div>

            <div class="col-md-6">
              <label class="form-label">å…§å®¹é é€£çµ (èª²ç¨‹/æŒ‘æˆ°)</label>
              <input type="url" class="form-control" id="content-url" 
                     placeholder="https://...">
            </div>

            <!-- æ¨™ç±¤ -->
            <div class="col-12">
              <label class="form-label">æ¨™ç±¤ (é€—è™Ÿåˆ†éš”)</label>
              <input type="text" class="form-control" id="product-tags" 
                     placeholder="beginner, template, figma">
            </div>

            <!-- èª²ç¨‹ç›¸é—œ -->
            <div class="col-md-4">
              <label class="form-label">ç¸½å–®å…ƒæ•¸ (èª²ç¨‹)</label>
              <input type="number" class="form-control" id="total-units" 
                     min="0" value="0">
            </div>

            <div class="col-md-4">
              <label class="form-label">å…è²»å–®å…ƒæ•¸</label>
              <input type="number" class="form-control" id="free-units" 
                     min="0" value="0">
            </div>

            <div class="col-md-4">
              <label class="form-label">å®Œæˆçå‹µé»æ•¸</label>
              <input type="number" class="form-control" id="credits-reward" 
                     min="0" value="0">
            </div>

            <!-- ç‹€æ…‹é–‹é—œ -->
            <div class="col-md-4">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="is-active" checked>
                <label class="form-check-label" for="is-active">
                  ä¸Šæ¶ç‹€æ…‹
                </label>
              </div>
            </div>

            <div class="col-md-4">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="is-featured">
                <label class="form-check-label" for="is-featured">
                  ç²¾é¸æ¨è–¦
                </label>
              </div>
            </div>

            <div class="col-md-4">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="preview-available">
                <label class="form-check-label" for="preview-available">
                  æ”¯æ´é è¦½
                </label>
              </div>
            </div>

            <!-- æäº¤æŒ‰éˆ• -->
            <div class="col-12">
              <button type="submit" class="btn btn-primary btn-lg me-2">
                <i class="fas fa-save me-2"></i>
                <span id="submit-btn-text">å»ºç«‹ç”¢å“</span>
              </button>
              <button type="button" class="btn btn-outline-secondary" id="cancel-btn">
                å–æ¶ˆ
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- ç”¢å“åˆ—è¡¨ -->
      <div class="product-form">
        <h4 class="mb-3">
          <i class="fas fa-list me-2"></i>
          ç¾æœ‰ç”¢å“ (<span id="products-count">0</span>)
        </h4>
        
        <div class="mb-3">
          <input type="text" class="form-control" id="search-products" 
                 placeholder="ğŸ” æœå°‹ç”¢å“...">
        </div>

        <div id="products-list">
          <div class="text-center py-5 text-muted">
            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
            <p>è¼‰å…¥ä¸­...</p>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    const WORKER_BASE = 'https://uxshari-workers.uxshari.workers.dev';
    let adminKey = '';
    let allProducts = [];
    let editingProductId = null;

    // é©—è­‰ç®¡ç†å“¡
    document.getElementById('verify-btn').addEventListener('click', async () => {
      const key = document.getElementById('admin-key-input').value.trim();
      if (!key) {
        alert('è«‹è¼¸å…¥ç®¡ç†å“¡å¯†é‘°');
        return;
      }

      try {
        // æ¸¬è©¦ API å‘¼å«é©—è­‰
        const response = await fetch(`${WORKER_BASE}/api/products?admin_key=${encodeURIComponent(key)}`);
        
        if (response.ok) {
          adminKey = key;
          document.getElementById('auth-section').classList.add('d-none');
          document.getElementById('admin-area').classList.remove('d-none');
          loadProducts();
        } else {
          alert('ç®¡ç†å“¡å¯†é‘°éŒ¯èª¤');
        }
      } catch (error) {
        alert('é©—è­‰å¤±æ•—ï¼š' + error.message);
      }
    });

    // è¼‰å…¥ç”¢å“åˆ—è¡¨
    async function loadProducts() {
      try {
        const response = await fetch(`${WORKER_BASE}/api/products`);
        const data = await response.json();
        
        if (data.ok) {
          allProducts = data.products;
          renderProducts();
        }
      } catch (error) {
        console.error('è¼‰å…¥ç”¢å“å¤±æ•—:', error);
        document.getElementById('products-list').innerHTML = `
          <div class="alert alert-danger">
            è¼‰å…¥å¤±æ•—ï¼š${error.message}
          </div>
        `;
      }
    }

    // æ¸²æŸ“ç”¢å“åˆ—è¡¨
    function renderProducts() {
      const searchTerm = document.getElementById('search-products').value.toLowerCase();
      const filtered = allProducts.filter(p => 
        p.title.toLowerCase().includes(searchTerm) ||
        p.description.toLowerCase().includes(searchTerm) ||
        p.type.includes(searchTerm)
      );

      document.getElementById('products-count').textContent = filtered.length;

      if (filtered.length === 0) {
        document.getElementById('products-list').innerHTML = `
          <div class="text-center py-5 text-muted">
            <i class="fas fa-box-open fa-3x mb-3"></i>
            <p>æ²’æœ‰ç”¢å“</p>
          </div>
        `;
        return;
      }

      document.getElementById('products-list').innerHTML = filtered.map(p => `
        <div class="product-list-item">
          <div class="row align-items-center">
            <div class="col-auto">
              <img src="${p.coverImage || '/assets/images/placeholder.jpg'}" 
                   class="product-thumbnail" alt="${p.title}">
            </div>
            <div class="col">
              <div class="d-flex align-items-center mb-1">
                <span class="badge bg-primary me-2">${p.type}</span>
                <span class="status-indicator ${p.isActive ? 'active' : 'inactive'}"></span>
                <span class="small text-muted">${p.isActive ? 'ä¸Šæ¶ä¸­' : 'å·²ä¸‹æ¶'}</span>
                ${p.isFeatured ? '<span class="badge bg-warning ms-2">ç²¾é¸</span>' : ''}
              </div>
              <h5 class="mb-1">${p.title}</h5>
              <p class="text-muted small mb-2">${p.description}</p>
              <div class="small text-muted">
                <span class="me-3">ğŸ’° $${p.price}</span>
                <span class="me-3">ğŸ“¦ ${p.category || 'N/A'}</span>
                <span>ğŸ†” ${p.id}</span>
              </div>
            </div>
            <div class="col-auto">
              <button class="btn btn-sm btn-outline-primary me-2" onclick="editProduct('${p.id}')">
                <i class="fas fa-edit"></i> ç·¨è¼¯
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${p.id}', '${p.title}')">
                <i class="fas fa-trash"></i> åˆªé™¤
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // æœå°‹
    document.getElementById('search-products').addEventListener('input', renderProducts);

    // æ–°å¢ç”¢å“
    document.getElementById('product-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      // é©—è­‰ Stripe Price ID æ ¼å¼
      const stripePriceId = document.getElementById('stripe-price-id').value.trim();
      if (!stripePriceId.startsWith('price_')) {
        alert('âŒ Stripe Price ID æ ¼å¼éŒ¯èª¤ï¼\n\nå¿…é ˆå¾ Stripe Dashboard è¤‡è£½çœŸå¯¦çš„ Price ID\næ­£ç¢ºæ ¼å¼ï¼šprice_1QKm8xHNWqZ9vYjJ\n\nè«‹å…ˆåœ¨ Stripe å»ºç«‹ç”¢å“ï¼Œå†è¤‡è£½ Price ID éä¾†ã€‚');
        document.getElementById('stripe-price-id').focus();
        return;
      }

      if (stripePriceId.length < 20) {
        alert('âŒ Price ID å¤ªçŸ­ï¼\n\né€™ä¸åƒæ˜¯çœŸå¯¦çš„ Stripe Price IDã€‚\nè«‹ç¢ºèªå·²å¾ Stripe Dashboard è¤‡è£½å®Œæ•´çš„ IDã€‚');
        document.getElementById('stripe-price-id').focus();
        return;
      }

      const productData = {
        type: document.getElementById('product-type').value,
        title: document.getElementById('product-title').value,
        description: document.getElementById('product-description').value,
        price: parseFloat(document.getElementById('product-price').value),
        category: document.getElementById('product-category').value,
        level: document.getElementById('product-level').value,
        stripeProductId: document.getElementById('stripe-product-id').value,
        stripePriceId: document.getElementById('stripe-price-id').value,
        coverImage: document.getElementById('cover-image').value,
        downloadUrl: document.getElementById('download-url').value,
        contentUrl: document.getElementById('content-url').value,
        tags: document.getElementById('product-tags').value.split(',').map(t => t.trim()).filter(t => t),
        totalUnits: parseInt(document.getElementById('total-units').value) || 0,
        freeUnits: parseInt(document.getElementById('free-units').value) || 0,
        creditsReward: parseInt(document.getElementById('credits-reward').value) || 0,
        isActive: document.getElementById('is-active').checked,
        isFeatured: document.getElementById('is-featured').checked,
        previewAvailable: document.getElementById('preview-available').checked
      };

      try {
        const url = editingProductId 
          ? `${WORKER_BASE}/api/products/${editingProductId}?admin_key=${encodeURIComponent(adminKey)}`
          : `${WORKER_BASE}/api/products?admin_key=${encodeURIComponent(adminKey)}`;
        
        const method = editingProductId ? 'PATCH' : 'POST';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(productData)
        });

        const result = await response.json();

        if (result.ok) {
          alert(editingProductId ? 'ç”¢å“å·²æ›´æ–°ï¼' : 'ç”¢å“å·²å»ºç«‹ï¼');
          cancelEdit();
          loadProducts();
        } else {
          alert('æ“ä½œå¤±æ•—ï¼š' + result.error);
        }
      } catch (error) {
        alert('éŒ¯èª¤ï¼š' + error.message);
      }
    });

    // ç·¨è¼¯ç”¢å“
    window.editProduct = function(productId) {
      const product = allProducts.find(p => p.id === productId);
      if (!product) return;

      editingProductId = productId;
      document.getElementById('form-title').textContent = 'ç·¨è¼¯ç”¢å“';
      document.getElementById('submit-btn-text').textContent = 'æ›´æ–°ç”¢å“';

      document.getElementById('product-type').value = product.type;
      document.getElementById('product-title').value = product.title;
      document.getElementById('product-description').value = product.description;
      document.getElementById('product-price').value = product.price;
      document.getElementById('product-category').value = product.category || '';
      document.getElementById('product-level').value = product.level || 'beginner';
      document.getElementById('stripe-product-id').value = product.stripeProductId || '';
      document.getElementById('stripe-price-id').value = product.stripePriceId || '';
      document.getElementById('cover-image').value = product.coverImage || '';
      document.getElementById('download-url').value = product.downloadUrl || '';
      document.getElementById('content-url').value = product.contentUrl || '';
      document.getElementById('product-tags').value = (product.tags || []).join(', ');
      document.getElementById('total-units').value = product.totalUnits || 0;
      document.getElementById('free-units').value = product.freeUnits || 0;
      document.getElementById('credits-reward').value = product.creditsReward || 0;
      document.getElementById('is-active').checked = product.isActive ?? true;
      document.getElementById('is-featured').checked = product.isFeatured ?? false;
      document.getElementById('preview-available').checked = product.previewAvailable ?? false;

      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    // åˆªé™¤ç”¢å“
    window.deleteProduct = async function(productId, title) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${title}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;

      try {
        const response = await fetch(
          `${WORKER_BASE}/api/products/${productId}?admin_key=${encodeURIComponent(adminKey)}`,
          { method: 'DELETE' }
        );

        const result = await response.json();

        if (result.ok) {
          alert('ç”¢å“å·²åˆªé™¤ï¼');
          loadProducts();
        } else {
          alert('åˆªé™¤å¤±æ•—ï¼š' + result.error);
        }
      } catch (error) {
        alert('éŒ¯èª¤ï¼š' + error.message);
      }
    };

    // å–æ¶ˆç·¨è¼¯
    document.getElementById('cancel-btn').addEventListener('click', cancelEdit);

    function cancelEdit() {
      editingProductId = null;
      document.getElementById('form-title').textContent = 'æ–°å¢ç”¢å“';
      document.getElementById('submit-btn-text').textContent = 'å»ºç«‹ç”¢å“';
      document.getElementById('product-form').reset();
      document.getElementById('is-active').checked = true;
    }
  </script>

</body>
</html>
