<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UXShari 會員專區 | 學習儀表板</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="assets/css/general.css">
  <style>
    /* Loading spinner */
    .spinner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    /* Credits card animation */
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .credits-updated {
      animation: pulse 0.5s ease-in-out;
    }
    
    /* Status badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      font-size: 0.875rem;
      font-weight: 600;
    }
    
    .status-badge.free {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      color: #6b7280;
    }
    
    .status-badge.paid {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
  </style>
</head>
<body class="min-vh-100 d-flex flex-column bg-light">

  <!-- Loading Spinner -->
  <div id="loading-overlay" class="spinner-overlay">
    <div class="text-center">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">載入中...</span>
      </div>
      <p class="mt-3 text-muted">載入您的資料...</p>
    </div>
  </div>

  <!-- Navbar -->
  <div id="navbar"></div>

  <!-- Main Content -->
  <main class="flex-grow-1 d-flex flex-column" style="padding-top:80px;">
    
    <!-- 會員狀態橫幅 -->
    <section class="container py-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h1 class="h4 mb-2">
                <i class="fas fa-user-circle text-primary-shari me-2"></i>
                你好，<span id="user-name">會員</span>！
              </h1>
              <div id="status-badge-container">
                <span class="status-badge free">
                  <i class="fas fa-star"></i>
                  免費會員
                </span>
              </div>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
              <button id="logout-btn" class="btn btn-outline-secondary">
                <i class="fas fa-sign-out-alt me-2"></i>
                登出
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 預約額度卡片 -->
    <section class="container py-2">
      <div class="card border-0 shadow-sm" id="credits-card">
        <div class="card-body p-4">
          <div class="row align-items-center g-4">
            <!-- 左側：額度顯示 -->
            <div class="col-md-6">
              <div class="d-flex align-items-center gap-3">
                <div class="icon-wrapper bg-primary bg-opacity-10 rounded-circle p-3">
                  <i class="fas fa-calendar-check fa-2x text-primary-shari"></i>
                </div>
                <div>
                  <h3 class="h5 mb-1">一對一輔導預約</h3>
                  <p class="text-muted small mb-0">
                    剩餘點數：<strong id="credits-count" class="text-primary-shari fs-4">-</strong> 次
                  </p>
                </div>
              </div>
            </div>

            <!-- 右側：動作按鈕 -->
            <div class="col-md-6 text-md-end">
              <button id="book-session-btn" class="btn btn-lg btn-primary-shari w-100 w-md-auto" disabled>
                <i class="fas fa-spinner fa-spin me-2"></i> 載入中...
              </button>
            </div>
          </div>

          <!-- 狀態訊息 -->
          <div id="no-credits-alert" class="alert alert-warning mt-3 d-none" role="alert">
            <i class="fas fa-info-circle me-2"></i>
            <strong>需要購買預約額度</strong>
            <p class="mb-2 small">每次 50 分鐘的一對一輔導需要 1 個額度（$33 USD）</p>
            <a id="buy-link" class="btn btn-sm btn-warning" target="_blank">
              <i class="fas fa-shopping-cart me-2"></i>
              購買 1 次輔導（$33）
            </a>
          </div>

          <div id="has-credits-alert" class="alert alert-success mt-3 d-none" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <strong>您已擁有預約額度！</strong>
            <p class="mb-0 small">點擊上方按鈕即可預約 Shari 的一對一輔導時段</p>
          </div>
        </div>
      </div>
    </section>

    <!-- 付款紀錄 -->
    <section class="container py-2">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-3">
          <h3 class="h5 mb-0">
            <i class="fas fa-receipt me-2"></i>
            付款紀錄
          </h3>
        </div>
        <div class="card-body">
          <div id="payments-list">
            <p class="text-muted text-center py-3">
              <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
              尚無付款紀錄
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- 預約紀錄 -->
    <section class="container py-2 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-3">
          <h3 class="h5 mb-0">
            <i class="fas fa-history me-2"></i>
            預約紀錄
          </h3>
        </div>
        <div class="card-body">
          <div id="bookings-list">
            <p class="text-muted text-center py-3">
              <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
              尚無預約紀錄
            </p>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Footer -->
  <footer class="footer bg-dark text-white py-3">
    <div class="container text-center">
      <p class="mb-0">&copy; 2025 UXShari. All rights reserved.</p>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase 配置
    const firebaseConfig = {
      apiKey: "AIzaSyCZs2a35ENke7G8K7pzAMKCY3HOoi-IUcU",
      authDomain: "uxshari-670fd.firebaseapp.com",
      projectId: "uxshari-670fd",
      appId: "1:907540538791:web:ed98ef4ba51c96de43c282"
    };

    if (!getApps().length) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    // 工具函數
    const encEmail = (e) => btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
    const hideLoading = () => document.getElementById('loading-overlay').style.display = 'none';
    const showLoading = () => document.getElementById('loading-overlay').style.display = 'flex';

    // UI 元素
    const elements = {
      userName: document.getElementById('user-name'),
      statusBadge: document.getElementById('status-badge-container'),
      creditsCount: document.getElementById('credits-count'),
      creditsCard: document.getElementById('credits-card'),
      bookBtn: document.getElementById('book-session-btn'),
      buyLink: document.getElementById('buy-link'),
      noCreditsAlert: document.getElementById('no-credits-alert'),
      hasCreditsAlert: document.getElementById('has-credits-alert'),
      paymentsList: document.getElementById('payments-list'),
      bookingsList: document.getElementById('bookings-list'),
      logoutBtn: document.getElementById('logout-btn')
    };

    // 登出功能
    elements.logoutBtn.addEventListener('click', async () => {
      if (confirm('確定要登出嗎？')) {
        try {
          await signOut(auth);
          window.location.href = '/login.html';
        } catch (error) {
          console.error('登出錯誤:', error);
          alert('登出失敗，請重試');
        }
      }
    });

    // 更新 UI
    function updateUI(userData) {
      const credits = userData?.credits ?? 0;
      const isPaid = userData?.isPaid ?? false;
      const payments = userData?.payments ?? [];
      const bookings = userData?.bookings ?? [];

      // 更新額度顯示（帶動畫）
      elements.creditsCount.textContent = credits;
      elements.creditsCard.classList.add('credits-updated');
      setTimeout(() => elements.creditsCard.classList.remove('credits-updated'), 500);

      // 更新會員狀態徽章
      if (isPaid) {
        elements.statusBadge.innerHTML = `
          <span class="status-badge paid">
            <i class="fas fa-crown"></i>
            付費會員
          </span>
        `;
      } else {
        elements.statusBadge.innerHTML = `
          <span class="status-badge free">
            <i class="fas fa-star"></i>
            免費會員
          </span>
        `;
      }

      // 更新預約按鈕
      if (credits > 0) {
        elements.bookBtn.disabled = false;
        elements.bookBtn.innerHTML = '<i class="fas fa-calendar-check me-2"></i> 立即預約 50 分鐘輔導';
        elements.bookBtn.onclick = () => {
          window.open('https://calendly.com/sharichungdesign/50min', '_blank');
        };
        elements.noCreditsAlert.classList.add('d-none');
        elements.hasCreditsAlert.classList.remove('d-none');
      } else {
        elements.bookBtn.disabled = true;
        elements.bookBtn.innerHTML = '<i class="fas fa-lock me-2"></i> 需先購買預約額度';
        elements.noCreditsAlert.classList.remove('d-none');
        elements.hasCreditsAlert.classList.add('d-none');
      }

      // 更新付款紀錄
      if (payments.length > 0) {
        elements.paymentsList.innerHTML = payments.reverse().map(p => `
          <div class="d-flex justify-content-between align-items-center border-bottom py-3">
            <div>
              <div class="fw-bold">${(p.currency||'USD').toUpperCase()} $${p.amount}</div>
              <div class="small text-muted">${new Date(p.createdAt).toLocaleString('zh-TW')}</div>
              ${p.receiptUrl ? `<a class="small" href="${p.receiptUrl}" target="_blank">查看收據</a>` : ''}
            </div>
            <span class="badge bg-success">已完成</span>
          </div>
        `).join('');
      }

      // 更新預約紀錄
      if (bookings.length > 0) {
        elements.bookingsList.innerHTML = bookings.reverse().map(b => {
          const status = b.status || 'scheduled';
          const date = b.canceledAt || b.createdAt;
          const badgeCls = status === 'canceled' ? 'bg-secondary' : 'bg-primary';
          const badgeText = status === 'canceled' ? '已取消' : '已預約';
          return `
            <div class="d-flex justify-content-between align-items-center border-bottom py-3">
              <div>
                <div class="fw-bold">一對一輔導</div>
                <div class="small text-muted">${new Date(date).toLocaleString('zh-TW')}</div>
              </div>
              <span class="badge ${badgeCls}">${badgeText}</span>
            </div>
          `;
        }).join('');
      }
    }

    // 監聽認證狀態
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        hideLoading();
        window.location.href = '/login.html';
        return;
      }

      // 更新用戶名稱
      elements.userName.textContent = user.displayName || user.email?.split('@')[0] || '會員';

      // 更新購買連結（預填 email）
      if (user.email) {
        const workerBase = 'https://uxshari-workers.uxshari.workers.dev';
        elements.buyLink.href = `${workerBase}/api/checkout-redirect?email=${encodeURIComponent(user.email)}&origin=${encodeURIComponent(location.origin)}`;
        elements.buyLink.target = '_self';
      }

      // 讀取 Firestore 資料（即時監聽）
      if (user.email) {
        const docRef = doc(db, "users_by_email", encEmail(user.email));
        
        // 使用 onSnapshot 實現即時更新
        onSnapshot(docRef, (snapshot) => {
          hideLoading();
          if (snapshot.exists()) {
            updateUI(snapshot.data());
          } else {
            updateUI({});
          }
        }, (error) => {
          console.error('Firestore 監聽錯誤:', error);
          hideLoading();
          alert('無法載入資料，請重新整理頁面');
        });
      } else {
        hideLoading();
      }
    });
  </script>

  <!-- Test Private Key -->
  <script>
    // 在瀏覽器 Console 測試
    const testKey = `-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC...
-----END PRIVATE KEY-----`;

    const cleaned = testKey
      .replace(/-----BEGIN PRIVATE KEY-----/g, "")
      .replace(/-----END PRIVATE KEY-----/g, "")
      .replace(/\n/g, "")
      .replace(/\s+/g, "");

    console.log("Length:", cleaned.length);
    console.log("Valid base64:", /^[A-Za-z0-9+/]*={0,2}$/.test(cleaned));
  </script>

</body>
</html>
