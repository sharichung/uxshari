rules_version = '2';
service cloud.firestore {
	match /databases/{database}/documents {
		function isSignedIn() {
			return request.auth != null;
		}

		// Each user can read/write their own profile in `users/{uid}`
		match /users/{uid} {
			allow read: if isSignedIn() && request.auth.uid == uid;
			allow write: if isSignedIn() && request.auth.uid == uid;
		}

		// Allow each authenticated user to read their own profile document in users_by_email,
		// where documents are keyed by base64url(email). We validate by comparing the
		// stored email field to the signed-in user's email from the auth token.
		match /users_by_email/{docId} {
			// Permit reads if:
			// 1) The document does not exist yet (so clients can check and get an empty snapshot), OR
			// 2) The stored email matches the signed-in user's email
			allow read: if isSignedIn() && (
				!exists(/databases/$(database)/documents/users_by_email/$(docId)) ||
				resource.data.email == request.auth.token.email
			);
			
			// Allow authenticated users to update their own uxChecklists
			// Only allow updating email and uxChecklists fields
			allow update: if isSignedIn() 
				&& resource.data.email == request.auth.token.email
				&& request.resource.data.keys().hasOnly(['email', 'uxChecklists', 'credits', 'isPaid', 'payments', 'purchasedProducts', 'lastPaymentDate', 'createdAt']);
			
			// Allow authenticated users to create their own document
			// The email in the document must match the authenticated user's email
			allow create: if isSignedIn() 
				&& request.auth.token.email == request.resource.data.email;
			
			// Deletion is still prohibited
			allow delete: if false;
		}
	}
}

